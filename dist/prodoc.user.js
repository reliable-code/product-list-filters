// ==UserScript==
// @name         Prodoc enhancer
// @description  Hide doctor cards by filter, enhance doctor page
// @grant        GM_addValueChangeListener
// @grant        GM_setValue
// @grant        GM_getValue
// @match        https://prodoctorov.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.6.73634211
// @icon         https://www.google.com/s2/favicons?sz=64&domain=prodoctorov.ru
// @author       reliable-code
// ==/UserScript==

(()=>{(()=>{"use strict";function xe(e){return e.replace(/\D/g,"")}function z(e){return e.replace(/[^\d.,-]/g,"")}function Me(e){return e.replace(/\s/g,"")}function ke(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Ue(e,t=document){return!!t.querySelector(e)}function c(e,t=document,n=!1){const r=t.querySelector(e);return n&&!r&&console.log(`No element found for selector: ${e}`),r}function N(e,t=document,n=!1){const r=t.querySelectorAll(e);return n&&!r.length&&console.log(`No elements found for selector: ${e}`),r}function Be(e,t,n){return[...e.querySelectorAll(t)].find(r=>r.textContent.trim().includes(n))}function Ve(e,t,n=!1,r=!1){const o=c(t,e,!0);return C(o,n,r)}function C(e,t=!1,n=!1,r=null){if(!e)return r===null?(console.log("No element found"),null):r;const o=e.innerText;return b(o,t,n)}function We(e,t,n=!1){const r=e[t];return C(r,n)}function $e(e,t=!1,n=!1){const r=e.textContent;return b(r,t,n)}function b(e,t,n){return t&&(e=z(e)),n&&(e=e.replace(",",".")),+e}function S(e,t){Object.assign(e.style,t)}function qe(e){return Object.entries(e).map(([t,n])=>`${t.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${n};`).join(" ")}function Ge(e){return e?e.split(";").filter(t=>t.trim()!=="").reduce((t,n)=>{const[r,o]=n.split(":").map(i=>i.trim()),u=r.replace(/-([a-z])/g,(i,s)=>s.toUpperCase());return t[u]=o,t},{}):{}}function Ke(e){const t=n=>n.nodeType===Node.TEXT_NODE&&n.textContent.trim()!==""?[n]:[...n.childNodes].flatMap(t);return t(e)}async function He(e,t,n=null){const r=e.querySelector(t);return r?Promise.resolve(r):new Promise(o=>{const u=new MutationObserver(s);u.observe(e,{childList:!0,subtree:!0});let i=null;n&&(i=setTimeout(()=>{u.disconnect(),console.log(`No element found for selector: ${t}`),o(null)},n));function s(){const p=e.querySelector(t);p&&(i&&clearTimeout(i),u.disconnect(),o(p))}})}async function Xe(e,t){return e.querySelector(t)?new Promise(r=>{const o=new MutationObserver(u);o.observe(e,{childList:!0,subtree:!0});function u(){e.querySelector(t)||(o.disconnect(),r())}}):Promise.resolve()}function O(e,t=250){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}function je(e,t){const n=new IntersectionObserver(r=>{r.forEach(o=>{o.isIntersecting&&(t(),Q(e))})});e.intersectionObserver=n,n.observe(e)}function Q(e){e.intersectionObserver&&(e.intersectionObserver.disconnect(),e.intersectionObserver=null)}function Y(e,t,n){const r=T(e,"text",t);return r.value=n,r}function J(e,t,n,r,o,u){const i=T(e,"number",t);return i.value=n,i.step=r,i.min=o,i.max=u,i}function Z(e,t,n){const r=T(e,"checkbox",t);return r.checked=n,r}function T(e={},t=null,n=null){const r=m("input",e);return t&&(r.type=t),n&&(r.addEventListener("keyup",O(n,200)),r.addEventListener("change",O(n,100))),r}function ze(e={},t=null){return m("span",e,t)}function R(e={},t=null,n=null){const r=m("a",e,t);return n&&(r.href=n),r}function Qe(e={},t=null,n=null){const r=m("button",e,t);return n&&(r.onclick=n),r}function f(e={},t=null){return m("div",e,t)}function m(e,t,n=null){if(typeof t!="object"||t===null)throw new TypeError("styles should be an object");const r=document.createElement(e);return S(r,t),n&&(r.innerHTML=n),r}const v="additionalLinksAppended",ee=["\u042F\u043D\u0434\u0435\u043A\u0441","\u041D\u0430\u041F\u043E\u043F\u0440\u0430\u0432\u043A\u0443","DocDoc","\u0414\u043E\u043A\u0442\u0443"];function F(e,t){t.classList.contains(v)||(ee.forEach(n=>{te(e,t,n)}),t.classList.add(v))}function te(e,t,n){const r=ne(e,n),o=R({},n,r),u=document.createElement("br");t.append(u,o)}function ne(e,t){const n=`${e} ${t}`;return`https://www.google.com/search?q=${encodeURIComponent(n)}&btnI`}const a={DOCTOR_DETAILS:".b-doctor-details__toc",DOCTOR_CARD_NAME:'.b-doctor-intro__title-first-line [itemprop="name"]',DOCTOR_INTRO_LEFT:".b-doctor-intro__left-side",REVIEWS_FILTER:".reviews-filter:not(.b-reviews-page__filter)",NAME_SPAN_HOLDER:".b-doctor-intro__title-first-line",NAME_SPAN:'[itemprop="name"]',REVIEWS_FILTER_SPAN:":scope > span",DOCTOR_CONTACTS:"#doctor-contacts",MORE_REVIEWS_BUTTON:'[data-qa="show_more_list_items"]'};function re(){oe(),ue(),ie(),y()}function oe(){const e=c(a.DOCTOR_CARD_NAME,document,!0);if(!e)return;const t=e.innerText.trim(),n=f();n.style.textAlign="center",c(a.DOCTOR_INTRO_LEFT).append(n),F(t,n)}function ue(){const e=c(a.REVIEWS_FILTER);if(!e)return;const t=c(a.NAME_SPAN_HOLDER,document,!0);if(!t)return;const n=c(a.NAME_SPAN,t,!0);if(!n)return;const r=f();r.style.position="absolute",r.classList.add("v-application");const o=f();o.style.position="relative",o.style.height="45px",o.append(r);const u=N(a.REVIEWS_FILTER_SPAN,e,!0);u.length<2||(u.slice(1).forEach(i=>{const s=i.cloneNode(!0);s.addEventListener("click",()=>{i.parentNode.scrollIntoView({behavior:"smooth"}),i.click()}),r.append(s)}),n.append(o))}function ie(){if(!c(a.DOCTOR_CONTACTS))return;const t=[...N(a.DOCTOR_DETAILS)].pop();if(!t)return;t.style.position="sticky",t.style.top="16px";const n=f({},"\u041C\u0435\u0441\u0442\u043E \u0440\u0430\u0431\u043E\u0442\u044B");n.classList.add("b-doctor-details__toc-title");const r=R({},null,"#doctor-contacts");r.classList.add("b-doctor-details__toc-item"),r.append(n),t.insertBefore(r,t.firstChild)}function y(){const e=c(a.MORE_REVIEWS_BUTTON);e&&!e.classList.contains("d-none")&&e.click(),setTimeout(y,250)}function A(e,t="common",n=!1){const{pathname:r}=window.location;return D(r,e,t,n)}function D(e,t,n,r=!1){const u=e.split("/")[t]||n;return r&&console.log(`Pathname element: ${u}`),u}function Ye(e,t="common",n=!1){const r=A(e,"",n);return L(r,t,n)}function L(e,t,n){if(!e)return t;const r=e.split("-").at(-1);return n&&console.log(`Pathname element ending: ${r}`),r}function Je(e,t,n="common",r=!1){const o=D(e,t,"",r);return L(o,n,r)}function Ze(e){const t=window.location.search;return ce(t,e)}function ce(e,t){return new URLSearchParams(e).get(t)}function se(e){return window.location.pathname.includes(e)}function et(e){return e.some(t=>se(t))}function tt(e){return window.location.pathname.split("/").some(n=>n===e)}function nt(e,t){e.parentNode.insertBefore(t,e.nextSibling)}function _(e){w(e),P(e,"none")}function le(e){e.intersectionObserver||runOnceOnIntersection(e,()=>_(e))}function g(e){const t=fe(e);P(e,t)}function ae(e,t){t?_(e):g(e)}function rt(e,t){t?le(e):(clearIntersectionObserver(e),g(e))}function P(e,t){e.style.display=t}function fe(e){return w(e),e.defaultDisplay}function w(e){if(e.defaultDisplay)return;const{display:t}=getComputedStyle(e);e.defaultDisplay=t}function ot(e,t,n=.3){t?pe(e,n):de(e)}function de(e){e.style.opacity=""}function pe(e,t=.3){e.style.opacity=t}function ut(e){e.style.order=""}function it(e,t){e.style.order=t}function ct(e,t){e.style.background=t}function st(e,t="custom-global-style"){let n=document.getElementById(t);n||(n=document.createElement("style"),n.id=t,n.type="text/css",document.head.appendChild(n)),n.textContent=e}function x(e){return e.value.toLowerCase().split(",").map(t=>t.trim()).filter(t=>t!=="")}function lt(e){return x(e).filter(t=>!t.startsWith("!"))}function M(e,t){return!me(e,t)}function me(e,t){if(!t.value)return!0;const n=e.toLowerCase(),r=x(t),o=[],u=[];return r.forEach(i=>{if(i.startsWith("!")){const s=i.substring(1);s&&u.push(s)}else o.push(i)}),o.every(i=>n.includes(i))&&u.every(i=>!n.includes(i))}function k(e,t){return t.value!=null&&e<t.value}function at(e,t){return t.value!=null&&e>t.value}function ft(e,t){return t.value!=null&&e!==t.value}function Ee(e,t,n=!1,r="customFiltersContainer"){let o=c(`#${r}`,e);if(o)if(n)o.remove();else return;o=f(),o.id=r,t(o,e)}function U(e,t,n={},r={}){const o=f(n,e),u=Y(r,t.updateValueFromEvent,t.value);return o.append(u),o}function B(e,t,n,r,o,u={},i={}){const s=f(u,e),p=J(i,t.updateValueFromEvent,t.value,n,r,o);return s.append(p),s}function Ce(e,t,n={},r={}){const o=f(n,e),u=Z(r,t.updateValueFromEvent,t.value);return o.append(u),o}function dt(e,t={},n={}){return createTextFilterControl("\u041F\u043E\u0438\u0441\u043A: ",e,t,n)}function pt(e,t={},n={},r=.1,o=3){return createNumberFilterControl("\u041C\u0438\u043D. \u0440\u0435\u0439\u0442\u0438\u043D\u0433: ",e,r,o,5,t,n)}function mt(e,t={},n={},r=.1,o=3){return createNumberFilterControl("\u041C\u0430\u043A\u0441. \u0440\u0435\u0439\u0442\u0438\u043D\u0433: ",e,r,o,5,t,n)}function he(e,t={},n={}){return V("\u041C\u0438\u043D. \u043E\u0442\u0437\u044B\u0432\u043E\u0432: ",e,t,n)}function Et(e,t={},n={}){return V("\u041C\u0430\u043A\u0441. \u043E\u0442\u0437\u044B\u0432\u043E\u0432: ",e,t,n)}function V(e,t,n={},r={}){return B(e,t,"1","1","999999",n,r)}function Ct(e,t={},n={}){return Ne("\u041C\u0438\u043D. \u0441\u043A\u0438\u0434\u043A\u0430: ",e,t,n)}function Ne(e,t,n={},r={}){return createNumberFilterControl(e,t,"5","0","100",n,r)}function ht(e,t={},n={}){return createNumberFilterControl("\u041C\u0438\u043D. \u043A\u0435\u0448\u0431\u0435\u043A: ",e,"5","0","100",t,n)}function W(e,t,n={},r={},o="250"){return createNumberFilterControl(e,t,o,"0","1000000",n,r)}function Nt(e,t={},n={},r="25"){return W("\u041C\u0438\u043D. \u0446\u0435\u043D\u0430: ",e,t,n,r)}function Tt(e,t={},n={},r="25"){return W("\u041C\u0430\u043A\u0441. \u0446\u0435\u043D\u0430: ",e,t,n,r)}function _t(e,t,n={},r={}){return createNumberFilterControl(e,t,"1","0","99999",n,r)}function gt(e,t={},n={}){return createCheckboxFilterControl("\u0411\u0435\u0437 \u0440\u0435\u0439\u0442\u0438\u043D\u0433\u0430: ",e,t,n)}function It(e,t={},n={}){return createCheckboxFilterControl("\u0421 \u0444\u043E\u0442\u043E: ",e,t,n)}function Te(e,t={},n={}){return Ce("\u0412\u043A\u043B: ",e,t,n)}const I={INPUT:{margin:"0px 4px"}},l={FILTERS_CONTAINER:{display:"flex",gridGap:"15px",marginTop:"5px",fontSize:"15px"},CONTROL:{display:"flex",alignItems:"center"},TEXT_INPUT:{...I.INPUT,width:"180px"},NUMBER_INPUT:{...I.INPUT,width:"45px"},CHECKBOX_INPUT:{...I.INPUT,width:"20px",height:"20px"}},d={DOCTOR_CARD:".b-doctor-card",DOCTOR_CARD_NAME:".b-doctor-card__name-surname",PROFILE_CARD:".b-profile-card",REVIEWS_LINK:":scope > a",EXPERIENCE_WRAP:".b-doctor-card__experience .mr-2 .ui-text",SPEC_WRAP:".b-doctor-card__spec",CLINIC_CONTAINER:"div.b-doctor-card__lpu-select",CLINIC_WRAP:".b-select__trigger-main-text"};class _e{constructor(t,n){this.value=t,this.onChange=n}onChangeIfDefined=()=>{this.onChange&&this.onChange()}}function ge(e){const{target:t}=e,{type:n}=t;switch(n){case"text":return`"${t.value}"`;case"number":return t.value;case"checkbox":return t.checked;default:return console.log(`Unknown input type: ${n}`),null}}function Ie(e){return e===""?null:JSON.parse(e)}const be=window.GM_setValue,bt=window.GM.setValue,Se=window.GM_getValue,St=window.GM_addValueChangeListener;class E extends _e{constructor(t,n=null,r=null){super(Se(t,n),r),this.storageKey=t,this.defaultValue=n}static create(t,n=null,r=null){return new E(t,n,r)}static createWithCompositeKey(t,n,r=null,o=null){const u=`${t}-${n}`;return new E(u,r,o)}updateValueFromEvent=t=>{const n=ge(t),r=Ie(n);this.updateValue(r)};updateValue(t){this.value!==t&&(be(this.storageKey,t),this.value=t,this.onChangeIfDefined())}clearValue(){this.updateValue(null)}resetValue(){this.updateValue(this.defaultValue)}}function Oe(e,t=null){return{createGlobalFilter(n,r=null,o=e){return E.create(n,r,o)},createSectionFilter(n,r=null,o=e){if(!t)throw new Error("sectionId must be provided to use createSectionFilter.");return E.createWithCompositeKey(t,n,r,o)}}}const Re=A(2),{createGlobalFilter:ve,createSectionFilter:h}=Oe(X,Re),$=h("spec-filter"),q=h("clinic-filter"),G=h("min-reviews-filter",10),K=h("min-experience-filter",5),H=ve("filter-enabled",!0);function Fe(e){Ee(e,ye),X()}function ye(e,t){S(e,l.FILTERS_CONTAINER);const n=U("\u0421\u043F\u0435\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F:",$,l.CONTROL,l.TEXT_INPUT),r=U("\u041A\u043B\u0438\u043D\u0438\u043A\u0430:",q,l.CONTROL,l.TEXT_INPUT),o=he(G,l.CONTROL,l.NUMBER_INPUT),u=B("\u041C\u0438\u043D. \u043E\u043F\u044B\u0442: ",K,"1","0","100",l.CONTROL,l.NUMBER_INPUT),i=Te(H,l.CONTROL,l.CHECKBOX_INPUT);e.append(n,r,o,u,i),t.prepend(e)}function X(){N(d.DOCTOR_CARD).forEach(Ae)}function Ae(e){if(!H.value){g(e);return}const t=c(d.PROFILE_CARD,e,!0),n=c(d.REVIEWS_LINK,t),r=c(d.EXPERIENCE_WRAP,e,!0);if(!n||!r){_(e);return}const u=c(d.SPEC_WRAP,e,!0).innerText.trim(),i=c(d.CLINIC_CONTAINER,e,!0),p=c(d.CLINIC_WRAP,i,!0).innerText.trim(),De=C(n,!0),Le=C(r,!0),Pe=M(u,$)||M(p,q)||k(De,G)||k(Le,K);ae(e,Pe);const we=c(d.DOCTOR_CARD_NAME,e,!0).innerText;F(we,t)}const j=c(".appointments_page");j?Fe(j):re()})();})();
