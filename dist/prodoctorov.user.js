// ==UserScript==
// @name         Prodoctorov List Clean
// @description  Remove profile cards by filter
// @match        https://prodoctorov.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.6.69825634
// @icon         https://www.google.com/s2/favicons?sz=64&domain=prodoctorov.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.-]/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display="block"){conditionToHide?hideElement(element):showElement(element,display)}function setElementDisplay(element,display){element.style.display=display}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);inputOnChange&&input.addEventListener("change",inputOnChange);style&&(input.style=style);return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function createLink(href=null,innerHTML=null,style=null){const link=document.createElement("a");href&&(link.href=href);innerHTML&&(link.innerHTML=innerHTML);style&&(link.style=style);return link}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=removeNonNumber(elementText));const elementNumber=+elementText;return elementNumber}


const storage=localStorage;function getStorageValueOrDefault(key,defaultValue){const localStorageItem=storage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}function setStorageValueFromEvent(event,keyName){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}storage.setItem(keyName,valueToSet);return valueToSet}class StorageValue{constructor(storageKey,defaultValue){this.value=getStorageValueOrDefault(storageKey,defaultValue);this.storageKey=storageKey}updateValueFromEvent=event=>{this.value=setStorageValueFromEvent(event,this.storageKey)}}


function createFilterControlNumber(titleText,storageValue,inputStep,inputMinValue,inputMaxValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(storageValue.updateValueFromEvent,inputStyle,storageValue.value,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,storageValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(storageValue.updateValueFromEvent,inputStyle,storageValue.value);filterControl.append(input);return filterControl}function createMinReviewsFilterControl(storageValue,controlStyle=null,inputStyle=null){return createFilterControlNumber("Минимально отзывов: ",storageValue,"1","1","999999",controlStyle,inputStyle)}function createEnabledFilterControl(storageValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Вкл: ",storageValue,controlStyle,inputStyle)}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer)return;filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


const APPOINTMENTS_PAGE=".appointments_page";const SPECIAL_PLACEMENT_CARD_SELECTOR=".b-doctor-card_special-placement";const DOCTOR_CARD_SELECTOR=".b-doctor-card";const DOCTOR_CARD_NAME_SELECTOR=".b-doctor-card__name-surname";const ADDITIONAL_LINKS_APPENDED_CLASS="additionalLinksAppended";const DOCTOR_DETAILS_MAIN_SELECTOR=".b-doctor-details__main";const DOCTOR_DETAILS_MENU_SELECTOR=".b-doctor-details__toc";const minReviewsFilter=new StorageValue("min-reviews-filter",10);const filterEnabled=new StorageValue("filter-enabled",true);const appointmentsPage=getFirstElement(APPOINTMENTS_PAGE);if(appointmentsPage)setInterval(initListClean,100);else{appendReviewsInfoToHeader();appendDoctorContactLink()}function initListClean(){removeSpecialPlacementCards();appendFilterControlsIfNeeded(appointmentsPage,appendFiltersContainer);cleanList()}function appendFiltersContainer(filtersContainer,parentNode){filtersContainer.style="display: flex;"+"grid-gap: 15px;"+"margin-top: 5px;"+"font-size: 15px;";const controlStyle="display: flex;"+"align-items: center;";const inputStyle="margin: 0px 4px;";const numberInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 45px;";const checkboxInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 20px;"+"height: 20px;";const minReviewsDiv=createMinReviewsFilterControl(minReviewsFilter,controlStyle,numberInputStyle);const filterEnabledDiv=createEnabledFilterControl(filterEnabled,controlStyle,checkboxInputStyle);filtersContainer.append(minReviewsDiv,filterEnabledDiv);parentNode.prepend(filtersContainer)}function removeSpecialPlacementCards(){const specialPlacementCards=getAllElements(SPECIAL_PLACEMENT_CARD_SELECTOR);specialPlacementCards.forEach((specialPlacementCard=>specialPlacementCard.remove()))}function cleanList(){const doctorCards=getAllElements(DOCTOR_CARD_SELECTOR,appointmentsPage);doctorCards.forEach((doctorCard=>{if(!filterEnabled.value){showElement(doctorCard,"flex");return}const profileCard=getFirstElement(".b-profile-card",doctorCard,true);const reviewsLink=getFirstElement(":scope > a",profileCard);if(!reviewsLink){hideElement(doctorCard);return}const reviewsLinkNumber=getElementInnerNumber(reviewsLink,true);showHideElement(doctorCard,reviewsLinkNumber<minReviewsFilter.value,"flex");appendAdditionalLinks(doctorCard,profileCard)}))}function appendAdditionalLinks(doctorCard,profileCard){if(profileCard.classList.contains(ADDITIONAL_LINKS_APPENDED_CLASS))return;appendAdditionalLink(doctorCard,profileCard,"НаПоправку");appendAdditionalLink(doctorCard,profileCard,"DocDoc");appendAdditionalLink(doctorCard,profileCard,"Докту");profileCard.classList.add(ADDITIONAL_LINKS_APPENDED_CLASS)}function appendAdditionalLink(doctorCard,profileCard,siteName){const doctorCardName=getFirstElement(DOCTOR_CARD_NAME_SELECTOR,doctorCard,true);const doctorName=doctorCardName.innerText;const searchString=`${doctorName} ${siteName}`;const encodedSearchString=encodeURIComponent(searchString);const lineBreak=document.createElement("br");const searchUrlLink=createLink(`https://www.google.com/search?q=${encodedSearchString}&btnI`,siteName);profileCard.append(lineBreak,searchUrlLink)}function appendReviewsInfoToHeader(){const reviewsFilter=getFirstElement(".reviews-filter:not(.b-reviews-page__filter)");if(!reviewsFilter)return;const nameSpanHolder=getFirstElement(".b-doctor-intro__title-first-line",document,true);if(!nameSpanHolder)return;const nameSpan=getFirstElement('[itemprop="name"]',nameSpanHolder,true);if(!nameSpan)return;const reviewsInfo=createDiv();reviewsInfo.classList.add("v-application");const reviewsFilterSpans=getAllElements(":scope > span",reviewsFilter,true);const lastReviewsFilterSpansIndex=reviewsFilterSpans.length-1;for(let i=1;i<=lastReviewsFilterSpansIndex;i+=1){const reviewsFilterSpan=reviewsFilterSpans[i];const reviewsFilterSpanCopy=reviewsFilterSpan.cloneNode(true);reviewsFilterSpanCopy.addEventListener("click",scrollToParentAndClick(reviewsFilterSpan));reviewsInfo.append(reviewsFilterSpanCopy)}nameSpan.append(reviewsInfo)}function scrollToParentAndClick(element){return()=>{element.parentNode.scrollIntoView({behavior:"smooth"});element.click()}}function appendDoctorContactLink(){const doctorDetailsMain=getFirstElement(DOCTOR_DETAILS_MAIN_SELECTOR);if(!doctorDetailsMain)return;const doctorContacts=getFirstElement(".b-doctor-contacts");if(!doctorContacts)return;const doctorContactsTitle=getFirstElement(".b-doctor-contacts__title",doctorContacts);doctorContactsTitle.remove();const doctorContactsBody=getFirstElement(".b-doctor-contacts__body",doctorContacts);doctorContactsBody.style.margin=0;const doctorContactsCopyWrap=createDiv();doctorContactsCopyWrap.classList.add("b-doctor-details__item","b-box","b-box_shadow");doctorContactsCopyWrap.append(doctorContacts);doctorDetailsMain.prepend(doctorContactsCopyWrap);const doctorDetailsMenu=getFirstElement(DOCTOR_DETAILS_MENU_SELECTOR);if(!doctorDetailsMenu)return;doctorDetailsMenu.style.position="sticky";doctorDetailsMenu.style.top="16px";const doctorContactsLinkTitle=createDiv("Место работы");doctorContactsLinkTitle.classList.add("b-doctor-details__toc-title");const doctorContactsLink=createLink("#doctor-contacts");doctorContactsLink.append(doctorContactsLinkTitle);doctorContactsLink.classList.add("b-doctor-details__toc-item");doctorDetailsMenu.insertBefore(doctorContactsLink,doctorDetailsMenu.firstChild)}})();