// ==UserScript==
// @name         Prodoctorov List Clean
// @description  Remove profile cards by filter
// @match        https://prodoctorov.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.5.69670137
// @icon         https://www.google.com/s2/favicons?sz=64&domain=prodoctorov.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";


function getFirstElement(parentNode,selector,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(parentNode,selector,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function setElementDisplay(element,display){element.style.display=display}function updateValue(event,keyName,needReload=true){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}localStorage.setItem(keyName,valueToSet);needReload&&window.location.reload();return valueToSet}function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,inputOnChange,controlStyle="",inputStyle=""){const filterControl=createDiv(titleText,controlStyle);const input=createBaseInput(inputOnChange,inputStyle);input.type="number";input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;filterControl.append(input);return filterControl}function createBaseInput(inputOnChange,style){const input=document.createElement("input");input.addEventListener("change",inputOnChange);input.style=style;return input}function createDiv(textContent,style=""){const div=document.createElement("div");div.textContent=textContent;div.style=style;return div}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=elementText.replace(/\D/g,""));const elementNumber=+elementText;return elementNumber}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(parentNode,`#${filtersContainerId}`);if(filtersContainer)return;filtersContainer=document.createElement("div");filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


function getLocalStorageValueOrDefault(key,defaultValue){const localStorageItem=localStorage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}


const MIN_REVIEWS_LOCAL_STORAGE_KEY="minReviewsFilter";const APPOINTMENTS_PAGE=".appointments_page";const SPECIAL_PLACEMENT_CARD_SELECTOR=".b-doctor-card_special-placement";const DOCTOR_CARD_SELECTOR=".b-doctor-card";const DOCTOR_CARD_NAME_SELECTOR=".b-doctor-card__name-surname";const ADDITIONAL_LINKS_APPENDED_CLASS="additionalLinksAppended";const MIN_REVIEWS=10;let minReviewsValue=getLocalStorageValueOrDefault(MIN_REVIEWS_LOCAL_STORAGE_KEY,MIN_REVIEWS);const appointmentsPage=getFirstElement(document,APPOINTMENTS_PAGE);appointmentsPage?setInterval(initListClean,500):appendReviewsInfoToHeader();function initListClean(){removeSpecialPlacementCards();appendFilterControlsIfNeeded(appointmentsPage,appendFiltersContainer);cleanList()}function appendFiltersContainer(filtersContainer,parentNode){const minReviewsDiv=createFilterControlNumber("Минимально отзывов: ",minReviewsValue,"1","1","999999",updateMinReviewsInput);filtersContainer.append(minReviewsDiv);parentNode.prepend(filtersContainer)}function updateMinReviewsInput(e){minReviewsValue=updateValue(e,MIN_REVIEWS_LOCAL_STORAGE_KEY,false)}function removeSpecialPlacementCards(){const specialPlacementCards=getAllElements(document,SPECIAL_PLACEMENT_CARD_SELECTOR);specialPlacementCards.forEach((specialPlacementCard=>specialPlacementCard.remove()))}function cleanList(){const doctorCards=getAllElements(appointmentsPage,DOCTOR_CARD_SELECTOR);doctorCards.forEach((doctorCard=>{const profileCard=getFirstElement(doctorCard,".b-profile-card",true);const reviewsLink=getFirstElement(profileCard,":scope > a");if(!reviewsLink){doctorCard.remove();return}const reviewsLinkNumber=getElementInnerNumber(reviewsLink,true);reviewsLinkNumber<minReviewsValue?hideElement(doctorCard):showElement(doctorCard,"flex");appendAdditionalLinks(doctorCard,profileCard)}))}function appendAdditionalLinks(doctorCard,profileCard){if(profileCard.classList.contains(ADDITIONAL_LINKS_APPENDED_CLASS))return;appendAdditionalLink(doctorCard,profileCard,"НаПоправку");appendAdditionalLink(doctorCard,profileCard,"DocDoc");appendAdditionalLink(doctorCard,profileCard,"Докту");profileCard.classList.add(ADDITIONAL_LINKS_APPENDED_CLASS)}function appendAdditionalLink(doctorCard,profileCard,siteName){const doctorCardName=getFirstElement(doctorCard,DOCTOR_CARD_NAME_SELECTOR,true);const doctorName=doctorCardName.innerText;const searchString=`${doctorName} ${siteName}`;const encodedSearchString=encodeURIComponent(searchString);const lineBreak=document.createElement("br");const searchUrlLink=document.createElement("a");searchUrlLink.href=`https://www.google.com/search?q=${encodedSearchString}&btnI`;searchUrlLink.textContent=siteName;profileCard.append(lineBreak,searchUrlLink)}function appendReviewsInfoToHeader(){const reviewsFilter=getFirstElement(document,".reviews-filter:not(.b-reviews-page__filter)");if(!reviewsFilter)return;const nameSpanHolder=getFirstElement(document,".b-doctor-intro__title-first-line",true);if(!nameSpanHolder)return;const nameSpan=getFirstElement(nameSpanHolder,'[itemprop="name"]',true);if(!nameSpan)return;const reviewsInfo=document.createElement("div");reviewsInfo.classList.add("v-application");const reviewsFilterSpans=getAllElements(reviewsFilter,":scope > span",true);const lastReviewsFilterSpansIndex=reviewsFilterSpans.length-1;for(let i=1;i<=lastReviewsFilterSpansIndex;i+=1){const reviewsFilterSpan=reviewsFilterSpans[i];const reviewsFilterSpanCopy=reviewsFilterSpan.cloneNode(true);reviewsFilterSpanCopy.addEventListener("click",scrollToParentAndClick(reviewsFilterSpan));reviewsInfo.append(reviewsFilterSpanCopy)}nameSpan.append(reviewsInfo)}function scrollToParentAndClick(element){return()=>{element.parentNode.scrollIntoView({behavior:"smooth"});element.click()}}})();