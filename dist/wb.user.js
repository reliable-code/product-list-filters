// ==UserScript==
// @name         WB List Clean
// @description  Remove product cards by filter
// @match        https://www.wildberries.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.5.69670137
// @icon         https://www.google.com/s2/favicons?sz=64&domain=wildberries.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";


function getFirstElement(parentNode,selector,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function setElementDisplay(element,display){element.style.display=display}function updateValue(event,keyName,needReload=true){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}localStorage.setItem(keyName,valueToSet);needReload&&window.location.reload();return valueToSet}function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,inputOnChange,controlStyle="",inputStyle=""){const filterControl=createDiv(titleText,controlStyle);const input=createBaseInput(inputOnChange,inputStyle);input.type="number";input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;filterControl.append(input);return filterControl}function createBaseInput(inputOnChange,style){const input=document.createElement("input");input.addEventListener("change",inputOnChange);input.style=style;return input}function createDiv(textContent,style=""){const div=document.createElement("div");div.textContent=textContent;div.style=style;return div}function getFirstElementInnerNumber(parentNode,selector,cleanText){const element=getFirstElement(parentNode,selector,true);const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=elementText.replace(/\D/g,""));const elementNumber=+elementText;return elementNumber}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(parentNode,`#${filtersContainerId}`);if(filtersContainer)return;filtersContainer=document.createElement("div");filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


function getLocalStorageValueOrDefault(key,defaultValue){const localStorageItem=localStorage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}


const MIN_REVIEWS=50;const MIN_RATING=4.8;const CATEGORY_NAME=getCategoryName();const MIN_REVIEWS_LOCAL_STORAGE_KEY=`${CATEGORY_NAME}-min-reviews-filter`;const MIN_RATING_LOCAL_STORAGE_KEY=`${CATEGORY_NAME}-min-rating-filter`;const FILTERS_BLOCK_WRAP_SELECTOR=".filters-block__wrap";const PRODUCT_CARD_SELECTOR=".product-card";const PRODUCT_CARD_REVIEWS_SELECTOR=".product-card__count";const PRODUCT_CARD_RATING_SELECTOR=".address-rate-mini";const PRODUCT_CARD_PRICE_SELECTOR=".price__lower-price";const PRICE_FILTER_URL_PARAMS_NAME="priceU";let minReviewsValue=getLocalStorageValueOrDefault(MIN_REVIEWS_LOCAL_STORAGE_KEY,MIN_REVIEWS);let minRatingValue=getLocalStorageValueOrDefault(MIN_RATING_LOCAL_STORAGE_KEY,MIN_RATING);let minPriceValue=getMinPriceValueFromURL();const minPriceDivTextContent=()=>`Минимальная цена: ${minPriceValue}`;function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const lastPathElement=pathElements.pop();const categoryName=lastPathElement||"common";return categoryName}function getMinPriceValueFromURL(){const params=new URLSearchParams(window.location.search);if(!params.has(PRICE_FILTER_URL_PARAMS_NAME))return 0;const priceFilterParams=params.get(PRICE_FILTER_URL_PARAMS_NAME);const priceFilterParamsArray=priceFilterParams.split(";");const minPriceFilterParam=priceFilterParamsArray[0];const minPriceFilterValue=minPriceFilterParam/100;return minPriceFilterValue}setInterval(initListClean,100);function initListClean(){const filtersBlockWrap=getFirstElement(document,FILTERS_BLOCK_WRAP_SELECTOR);if(filtersBlockWrap){removeRecentItemsBlock();appendFilterControlsIfNeeded(filtersBlockWrap,appendFiltersContainer);cleanList()}}function removeRecentItemsBlock(){const recentItems=document.querySelector(".j-recent-items");if(recentItems){const{parentNode}=recentItems;parentNode.remove()}}function appendFiltersContainer(filtersContainer,parentNode){filtersContainer.style="display: flex;";const controlStyle="padding-left: 7px; margin-top: 14px;";const minReviewsDiv=createFilterControlNumber("Минимально отзывов: ",minReviewsValue,"1","1","999999",updateMinReviewsInput,controlStyle);const minRatingDiv=createFilterControlNumber("Минимальный рейтинг: ",minRatingValue,"0.1","4.0","5.0",updateMinRatingInput,controlStyle);const minPriceDiv=createDiv(minPriceDivTextContent(),controlStyle);setInterval((()=>checkMinPrice(minPriceDiv)),500);filtersContainer.append(minReviewsDiv,minRatingDiv,minPriceDiv);parentNode.append(filtersContainer)}function updateMinReviewsInput(e){minReviewsValue=updateValue(e,MIN_REVIEWS_LOCAL_STORAGE_KEY,false)}function updateMinRatingInput(e){minRatingValue=updateValue(e,MIN_RATING_LOCAL_STORAGE_KEY,false)}function checkMinPrice(minPriceDiv){const currentMinPriceValue=getMinPriceValueFromURL();if(minPriceValue!==currentMinPriceValue){minPriceValue=currentMinPriceValue;minPriceDiv.textContent=minPriceDivTextContent()}}function cleanList(){const productCards=document.querySelectorAll(PRODUCT_CARD_SELECTOR);productCards.forEach((productCard=>{const productCardReviewsNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_REVIEWS_SELECTOR,true);const productCardRatingNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_RATING_SELECTOR);const productCardPriceNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_PRICE_SELECTOR,true);productCardReviewsNumber<minReviewsValue||productCardRatingNumber<minRatingValue||productCardPriceNumber<minPriceValue?hideElement(productCard):showElement(productCard)}))}})();