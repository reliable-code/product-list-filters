// ==UserScript==
// @name         WB List Clean
// @description  Remove product cards by filter
// @match        https://www.wildberries.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.7.69997596
// @icon         https://www.google.com/s2/favicons?sz=64&domain=wildberries.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.,-]/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display="block"){conditionToHide?hideElement(element):showElement(element,display)}function setElementDisplay(element,display){element.style.display=display}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);inputOnChange&&input.addEventListener("change",inputOnChange);style&&(input.style=style);return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function getFirstElementInnerNumber(parentNode,selector,cleanText){const element=getFirstElement(selector,parentNode,true);const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function getElementInnerNumber(element,cleanText=false,replaceComma=false){let elementText=element.innerText;cleanText&&(elementText=removeNonNumber(elementText));replaceComma&&(elementText=elementText.replace(",","."));const elementNumber=+elementText;return elementNumber}function getInputValueFromEvent(event){const{target}=event;const{type}=target;let inputValue;if(type==="number")inputValue=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}inputValue=target.checked}return parseValue(inputValue)}class InputValueBase{constructor(value,onChange){this.value=value;this.onChange=onChange}onChangeIfDefined=()=>{this.onChange&&this.onChange()}}function parseValue(value){return value===""?null:JSON.parse(value)}


const storage=localStorage;function getStorageValueOrDefault(key,defaultValue){const localStorageItem=storage.getItem(key);return localStorageItem===null?defaultValue:parseValue(localStorageItem)}function setStorageValueFromEvent(event,keyName){const inputValue=getInputValueFromEvent(event);storage.setItem(keyName,inputValue);return inputValue}class StorageValue extends InputValueBase{constructor(storageKey,defaultValue=null,onChange=null){super(getStorageValueOrDefault(storageKey,defaultValue),onChange);this.storageKey=storageKey}updateValueFromEvent=event=>{this.value=setStorageValueFromEvent(event,this.storageKey);this.onChangeIfDefined()}}


function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,inputValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value);filterControl.append(input);return filterControl}function createMinRatingFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlNumber("Минимальный рейтинг: ",inputValue,"0.1","3.0","5.0",controlStyle,inputStyle)}function createMinReviewsFilterControl(inputValue,controlStyle=null,inputStyle=null){return createReviewsFilterControl("Минимально отзывов: ",inputValue,controlStyle,inputStyle)}function createReviewsFilterControl(titleText,inputValue,controlStyle=null,inputStyle=null){return createFilterControlNumber(titleText,inputValue,"1","1","999999",controlStyle,inputStyle)}function createEnabledFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Вкл: ",inputValue,controlStyle,inputStyle)}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer)return;filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}function isLessThanFilter(parameterValue,filterValue){return filterValue&&parameterValue<filterValue}


const FILTERS_BLOCK_WRAP_SELECTOR=".filters-block__wrap";const PRODUCT_CARD_SELECTOR=".product-card";const PRODUCT_CARD_REVIEWS_SELECTOR=".product-card__count";const PRODUCT_CARD_RATING_SELECTOR=".address-rate-mini";const PRODUCT_CARD_PRICE_SELECTOR=".price__lower-price";const PRICE_FILTER_URL_PARAMS_NAME="priceU";const CATEGORY_NAME=getCategoryName();const minReviewsFilter=new StorageValue(`${CATEGORY_NAME}-min-reviews-filter`);const minRatingFilter=new StorageValue(`${CATEGORY_NAME}-min-rating-filter`,4.8);const filterEnabled=new StorageValue(`${CATEGORY_NAME}-filter-enabled`,true);let minPriceValue=getMinPriceValueFromURL();const minPriceDivTextContent=()=>`Минимальная цена: ${minPriceValue}`;function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const lastPathElement=pathElements.pop();const categoryName=lastPathElement||"common";return categoryName}function getMinPriceValueFromURL(){const params=new URLSearchParams(window.location.search);if(!params.has(PRICE_FILTER_URL_PARAMS_NAME))return 0;const priceFilterParams=params.get(PRICE_FILTER_URL_PARAMS_NAME);const priceFilterParamsArray=priceFilterParams.split(";");const minPriceFilterParam=priceFilterParamsArray[0];const minPriceFilterValue=minPriceFilterParam/100;return minPriceFilterValue}setInterval(initListClean,100);function initListClean(){const filtersBlockWrap=getFirstElement(FILTERS_BLOCK_WRAP_SELECTOR);if(filtersBlockWrap){removeRecentItemsBlock();appendFilterControlsIfNeeded(filtersBlockWrap,appendFiltersContainer);cleanList()}}function removeRecentItemsBlock(){const recentItems=getFirstElement(".j-recent-items");if(recentItems){const{parentNode}=recentItems;parentNode.remove()}}function appendFiltersContainer(filtersContainer,parentNode){filtersContainer.style="display: flex;"+"grid-gap: 15px;"+"margin-top: 14px;";const controlStyle="display: flex;"+"align-items: center;";const priceControlStyle=controlStyle+// eslint-disable-line prefer-template
"margin-right: 37px;";const inputStyle="margin: 0px 4px;";const numberInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 55px;";const checkboxInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 22px;"+"height: 22px;";const minReviewsDiv=createMinReviewsFilterControl(minReviewsFilter,controlStyle,numberInputStyle);const minRatingDiv=createMinRatingFilterControl(minRatingFilter,controlStyle,numberInputStyle);const minPriceDiv=createDiv(minPriceDivTextContent(),priceControlStyle);const filterEnabledDiv=createEnabledFilterControl(filterEnabled,controlStyle,checkboxInputStyle);setInterval((()=>checkMinPrice(minPriceDiv)),500);filtersContainer.append(minReviewsDiv,minRatingDiv,minPriceDiv,filterEnabledDiv);parentNode.append(filtersContainer)}function checkMinPrice(minPriceDiv){const currentMinPriceValue=getMinPriceValueFromURL();if(minPriceValue!==currentMinPriceValue){minPriceValue=currentMinPriceValue;minPriceDiv.textContent=minPriceDivTextContent()}}function cleanList(){const productCards=getAllElements(PRODUCT_CARD_SELECTOR);productCards.forEach((productCard=>{if(!filterEnabled.value){showElement(productCard);return}const productCardReviewsNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_REVIEWS_SELECTOR,true);const productCardRatingNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_RATING_SELECTOR);const productCardPriceNumber=getFirstElementInnerNumber(productCard,PRODUCT_CARD_PRICE_SELECTOR,true);const conditionToHide=isLessThanFilter(productCardReviewsNumber,minReviewsFilter.value)||isLessThanFilter(productCardRatingNumber,minRatingFilter.value)||productCardPriceNumber<minPriceValue;showHideElement(productCard,conditionToHide)}))}})();