// ==UserScript==
// @name         Lenta List Clean
// @description  Remove product cards by filter
// @match        https://*.online.lenta.com/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.3.69825634
// @icon         https://www.google.com/s2/favicons?sz=64&domain=lenta.com
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.-]/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display="block"){conditionToHide?hideElement(element):showElement(element,display)}function setElementDisplay(element,display){element.style.display=display}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);inputOnChange&&input.addEventListener("change",inputOnChange);style&&(input.style=style);return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=removeNonNumber(elementText));const elementNumber=+elementText;return elementNumber}


const storage=localStorage;function getStorageValueOrDefault(key,defaultValue){const localStorageItem=storage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}function setStorageValueFromEvent(event,keyName){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}storage.setItem(keyName,valueToSet);return valueToSet}class StorageValue{constructor(storageKey,defaultValue){this.value=getStorageValueOrDefault(storageKey,defaultValue);this.storageKey=storageKey}updateValueFromEvent=event=>{this.value=setStorageValueFromEvent(event,this.storageKey)}}


function createFilterControlNumber(titleText,storageValue,inputStep,inputMinValue,inputMaxValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(storageValue.updateValueFromEvent,inputStyle,storageValue.value,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,storageValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(storageValue.updateValueFromEvent,inputStyle,storageValue.value);filterControl.append(input);return filterControl}function createMinRatingFilterControl(storageValue,controlStyle=null,inputStyle=null){return createFilterControlNumber("Минимальный рейтинг: ",storageValue,"0.1","3.0","5.0",controlStyle,inputStyle)}function createNoRatingFilterControl(storageValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Без рейтинга: ",storageValue,controlStyle,inputStyle)}function createEnabledFilterControl(storageValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Вкл: ",storageValue,controlStyle,inputStyle)}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer)return;filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


const CATEGORY_NAME=getCategoryName();const minRatingFilter=new StorageValue(`${CATEGORY_NAME}-min-rating-filter`,4);const noRatingFilter=new StorageValue(`${CATEGORY_NAME}-no-rating-filter`,false);const filterEnabled=new StorageValue(`${CATEGORY_NAME}-filter-enabled`,true);const PRODUCT_CARD_LIST_SELECTOR=".catalog-list";const PRODUCT_CARD_SELECTOR=".catalog-grid_new__item";const PRODUCT_CARD_RATING_SELECTOR=".rating-number";function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const lastPathElement=pathElements.pop();const categoryName=/^\d+$/.test(lastPathElement)?lastPathElement:"common";return categoryName}setInterval(initListClean,500);function initListClean(){const productCardList=getFirstElement(PRODUCT_CARD_LIST_SELECTOR);if(productCardList){appendFilterControlsIfNeeded(productCardList,appendFiltersContainer);cleanList()}}function appendFiltersContainer(filtersContainer,parentNode){filtersContainer.style="display: flex;"+"grid-gap: 15px;"+"margin-left: 10px;";const controlStyle="display: flex;"+"align-items: center;";const numberInputStyle="border: 1px solid #C9C9C9;"+"border-radius: 8px;"+"height: 40px;"+"padding: 0 16px;";const checkboxInputStyle="border: 1px solid #C9C9C9;"+"border-radius: 4px;"+"width: 22px;"+"height: 22px;";const minRatingDiv=createMinRatingFilterControl(minRatingFilter,controlStyle,numberInputStyle);const noRatingDiv=createNoRatingFilterControl(noRatingFilter,controlStyle,checkboxInputStyle);const filterEnabledDiv=createEnabledFilterControl(filterEnabled,controlStyle,checkboxInputStyle);filtersContainer.append(minRatingDiv,noRatingDiv,filterEnabledDiv);parentNode.prepend(filtersContainer)}function expandProductCardName(productCard){const productCardName=getFirstElement(".lu-product-card-name_new",productCard);productCardName.style.display="inline-block";productCardName.style.height="91px"}function cleanList(){const productCards=getAllElements(PRODUCT_CARD_SELECTOR);productCards.forEach((productCard=>{expandProductCardName(productCard);if(!filterEnabled.value){showElement(productCard);return}const productCardRating=getFirstElement(PRODUCT_CARD_RATING_SELECTOR,productCard);if(!productCardRating){showHideElement(productCard,!noRatingFilter.value);return}const productCardRatingNumber=getElementInnerNumber(productCardRating);showHideElement(productCard,productCardRatingNumber<minRatingFilter.value)}))}})();