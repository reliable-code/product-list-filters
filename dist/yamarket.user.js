// ==UserScript==
// @name         Yamarket List Clean
// @description  Remove product cards by filter
// @match        https://market.yandex.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.4.69671798
// @icon         https://www.google.com/s2/favicons?sz=64&domain=market.yandex.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";


function getFirstElement(parentNode,selector,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(parentNode,selector,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function insertAfter(existingNode,newNode){existingNode.parentNode.insertBefore(newNode,existingNode.nextSibling)}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function setElementDisplay(element,display){element.style.display=display}function updateValue(event,keyName){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}localStorage.setItem(keyName,valueToSet);return valueToSet}function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,inputOnChange,controlStyle="",inputStyle=""){const filterControl=createDiv(titleText,controlStyle);const input=createBaseInput(inputOnChange,inputStyle);input.type="number";input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;filterControl.append(input);return filterControl}function createBaseInput(inputOnChange,style){const input=document.createElement("input");input.addEventListener("change",inputOnChange);input.style=style;return input}function createDiv(textContent,style=""){const div=document.createElement("div");div.textContent=textContent;div.style=style;return div}function createMinRatingFilterControl(inputValue,inputOnChange,controlStyle="",inputStyle=""){return createFilterControlNumber("Минимальный рейтинг: ",inputValue,"0.1","3.0","5.0",inputOnChange,controlStyle,inputStyle)}function createMinReviewsFilterControl(inputValue,inputOnChange,controlStyle="",inputStyle=""){return createFilterControlNumber("Минимально отзывов: ",inputValue,"1","1","999999",inputOnChange,controlStyle,inputStyle)}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=elementText.replace(/\D/g,""));const elementNumber=+elementText;return elementNumber}function getArrayElementInnerNumber(array,elementIndex,cleanText=false){const element=array[elementIndex];const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(parentNode,`#${filtersContainerId}`);if(filtersContainer)return;filtersContainer=document.createElement("div");filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


function getLocalStorageValueOrDefault(key,defaultValue){const localStorageItem=localStorage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}


const MIN_REVIEWS=5;const MIN_RATING=4.8;const SEARCH_CONTROLS_SELECTOR='[data-apiary-widget-name="@marketplace/SearchControls"]';const VIRTUOSO_SCROLLER_SELECTOR='[data-virtuoso-scroller="true"]';const PRODUCT_CARD_SNIPPET_SELECTOR='[data-autotest-id="product-snippet"]';const PRODUCT_CARD_PARENT_ATTRIBUTE="data-apiary-widget-name";const CATEGORY_NAME=getCategoryName();const MIN_REVIEWS_LOCAL_STORAGE_KEY=`${CATEGORY_NAME}-min-reviews-filter`;const MIN_RATING_LOCAL_STORAGE_KEY=`${CATEGORY_NAME}-min-rating-filter`;let minReviewsValue=getLocalStorageValueOrDefault(MIN_REVIEWS_LOCAL_STORAGE_KEY,MIN_REVIEWS);let minRatingValue=getLocalStorageValueOrDefault(MIN_RATING_LOCAL_STORAGE_KEY,MIN_RATING);function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const categoryName=pathElements[1]??"common";return categoryName}const searchControls=getFirstElement(document,SEARCH_CONTROLS_SELECTOR);if(searchControls){appendFilterControlsIfNeeded(searchControls,appendFiltersContainer);setInterval(cleanList,500)}function appendFiltersContainer(filterControls,parentNode){filterControls.style="display: flex;"+"gap: 10px;"+"padding: 0 10px 15px;"+"font-size: 16px;"+"font-weight: 500;";const inputStyle="border-radius: 7px;"+"border: none;"+"padding: 9px 11px;"+"box-shadow: inset 0 0 0 1.5px #d2d0cc;";const minReviewsDiv=createMinReviewsFilterControl(minReviewsValue,updateMinReviewsInput,"",inputStyle);const minRatingDiv=createMinRatingFilterControl(minRatingValue,updateMinRatingInput,"",inputStyle);filterControls.append(minReviewsDiv,minRatingDiv);insertAfter(parentNode,filterControls)}function updateMinReviewsInput(e){minReviewsValue=updateValue(e,MIN_REVIEWS_LOCAL_STORAGE_KEY)}function updateMinRatingInput(e){minRatingValue=updateValue(e,MIN_RATING_LOCAL_STORAGE_KEY)}function cleanList(){const virtuosoScrollers=getAllElements(document,VIRTUOSO_SCROLLER_SELECTOR);virtuosoScrollers.forEach((virtuosoScroller=>{virtuosoScroller.style.minHeight="0"}));const productCardSnippets=getAllElements(document,PRODUCT_CARD_SNIPPET_SELECTOR);productCardSnippets.forEach((productCardSnippet=>{const productCardSnippetParent=productCardSnippet.parentNode;const isFirstLoad=productCardSnippetParent.hasAttribute(PRODUCT_CARD_PARENT_ATTRIBUTE);const productCard=isFirstLoad?productCardSnippetParent.parentNode.parentNode:productCardSnippetParent;const ratingMeter=getFirstElement(productCardSnippet,'[role="meter"]');if(!ratingMeter){productCard.remove();return}const ratingInfoWrap=ratingMeter.parentNode;const ratingInfoSpans=getAllElements(ratingInfoWrap,":scope > span");const productCardReviewsNumber=getArrayElementInnerNumber(ratingInfoSpans,1);const productCardRatingNumber=getArrayElementInnerNumber(ratingInfoSpans,0);productCardReviewsNumber<minReviewsValue||productCardRatingNumber<minRatingValue?hideElement(productCard):showElement(productCard)}))}})();