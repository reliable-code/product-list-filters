// ==UserScript==
// @name         Ozon List Clean
// @description  Remove product cards by filter
// @match        https://www.ozon.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.8.70601145
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ozon.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";


const thumbsDownIcon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n'+'<path d="M7.99997 4H17.1919C17.9865 4 18.7058 4.47039 19.0243 5.19836L21.8323 11.6167C21.9429 11.8695 22 12.1424 22 12.4184V13C22 14.1046 21.1045 15 20 15H13.5L14.7066 19.4243C14.8772 20.0498 14.5826 20.7087 14.0027 20.9986V20.9986C13.4204 21.2898 12.7134 21.1274 12.3164 20.6114L8.41472 15.5392C8.14579 15.1896 7.99997 14.7608 7.99997 14.3198V14M7.99997 4H2V14H7.99997M7.99997 4V14" stroke="#005bff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n'+"</svg>";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.,-]/g,"")}function removeSpaces(stringValue){return stringValue.replace(/\s/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function insertAfter(existingNode,newNode){existingNode.parentNode.insertBefore(newNode,existingNode.nextSibling)}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display="block"){conditionToHide?hideElement(element):showElement(element,display)}function setElementDisplay(element,display){element.style.display=display}function createTextInput(inputOnChange,inputStyle,inputValue){const input=createInput("text",inputOnChange,inputStyle);input.value=inputValue;return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);if(inputOnChange){input.addEventListener("keyup",inputOnChange);input.addEventListener("change",inputOnChange)}style&&(input.style=style);return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function createLink(href=null,innerHTML=null,style=null){const link=document.createElement("a");href&&(link.href=href);innerHTML&&(link.innerHTML=innerHTML);style&&(link.style=style);return link}function getElementInnerNumber(element,cleanText=false,replaceComma=false){const elementText=element.innerText;return parseNumber(elementText,cleanText,replaceComma)}function getArrayElementInnerNumber(array,elementIndex,cleanText=false){const element=array[elementIndex];const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function parseNumber(text,cleanText,replaceComma){cleanText&&(text=removeNonNumber(text));replaceComma&&(text=text.replace(",","."));const number=+text;return number}function waitForElement(parentNode,selector,timeout=null){return new Promise((resolve=>{const observer=new MutationObserver(mutationCallback);observer.observe(parentNode,{childList:true,subtree:true});let timeoutId=null;timeout&&(timeoutId=setTimeout((()=>{observer.disconnect();console.log(`No element found for selector: ${selector}`);resolve(null)}),timeout));function mutationCallback(){if(parentNode.querySelector(selector)){timeoutId&&clearTimeout(timeoutId);observer.disconnect();resolve(parentNode.querySelector(selector))}}}))}function addGlobalStyle(css){const style=document.createElement("style");style.type="text/css";style.textContent=css;document.head.appendChild(style)}function getInputValueFromEvent(event){const{target}=event;const{type}=target;switch(type){case"text":return`"${target.value}"`;case"number":return target.value;case"checkbox":return target.checked;default:console.log(`Unknown input type: ${type}`);return null}}class InputValueBase{constructor(value,onChange){this.value=value;this.onChange=onChange}onChangeIfDefined=()=>{this.onChange&&this.onChange()}}function parseValue(value){return value===""?null:JSON.parse(value)}


const storage=localStorage;function getStorageValueOrDefault(key,defaultValue){const localStorageItem=storage.getItem(key);return localStorageItem===null?defaultValue:parseValue(localStorageItem)}class StorageValue extends InputValueBase{constructor(storageKey,defaultValue=null,onChange=null){super(getStorageValueOrDefault(storageKey,defaultValue),onChange);this.storageKey=storageKey}updateValueFromEvent=event=>{const newValue=getInputValueFromEvent(event);const newParsedValue=parseValue(newValue);if(this.value===newParsedValue)return;storage.setItem(this.storageKey,newValue);this.value=newParsedValue;this.onChangeIfDefined()}}


function createFilterControlText(titleText,inputValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createTextInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value);filterControl.append(input);return filterControl}function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,inputValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value);filterControl.append(input);return filterControl}function createNameFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlText("Содержит: ",inputValue,controlStyle,inputStyle)}function createMinRatingFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlNumber("Минимальный рейтинг: ",inputValue,"0.1","3.0","5.0",controlStyle,inputStyle)}function createMinReviewsFilterControl(inputValue,controlStyle=null,inputStyle=null){return createReviewsFilterControl("Минимально отзывов: ",inputValue,controlStyle,inputStyle)}function createMaxReviewsFilterControl(inputValue,controlStyle=null,inputStyle=null){return createReviewsFilterControl("Максимально отзывов: ",inputValue,controlStyle,inputStyle)}function createReviewsFilterControl(titleText,inputValue,controlStyle=null,inputStyle=null){return createFilterControlNumber(titleText,inputValue,"1","1","999999",controlStyle,inputStyle)}function createEnabledFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Вкл: ",inputValue,controlStyle,inputStyle)}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,force=false,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer){if(!force)return;filtersContainer.remove()}filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}function isNotMatchTextFilter(parameterValue,filter){return!isMatchTextFilter(parameterValue,filter)}function isMatchTextFilter(parameterValue,filter){if(!filter.value)return true;const comparedString=parameterValue.toLowerCase();const searchStrings=filter.value.toLowerCase().split(",").map((searchString=>searchString.trim()));const{include:includeSearchStrings,notInclude:notIncludeSearchStrings}=searchStrings.reduce(((result,searchString)=>{if(searchString.startsWith("!")){const notIncludeSearchString=searchString.substring(1);notIncludeSearchString.length&&result.notInclude.push(notIncludeSearchString)}else result.include.push(searchString);return result}),{include:[],notInclude:[]});return includeSearchStrings.every((searchString=>comparedString.includes(searchString)))&&notIncludeSearchStrings.every((searchString=>!comparedString.includes(searchString)))}function isLessThanFilter(parameterValue,filter){return filter.value&&parameterValue<filter.value}function isGreaterThanFilter(parameterValue,filter){return filter.value&&parameterValue>filter.value}


const PAGINATOR_CONTENT_SELECTOR="#paginatorContent";const PRODUCT_REVIEWS_WRAP_SELECTOR='[data-widget="webReviewProductScore"]';const COMMENTS_SELECTOR="#comments";const SEARCH_RESULTS_SORT_SELECTOR='[data-widget="searchResultsSort"]';const PRODUCT_CARDS_SELECTOR=".widget-search-result-container > div > div";const PRODUCT_CARD_NAME_SELECTOR=".tsBody500Medium";const PRODUCT_CARD_RATING_WRAP_SELECTOR=".tsBodyMBold";const CREATE_REVIEW_BUTTON_SELECTOR='[data-widget="createReviewButton"]';const CATEGORY_NAME=getCategoryName();const nameFilter=new StorageValue(`${CATEGORY_NAME}-name-filter`,null,cleanList);const minReviewsFilter=new StorageValue(`${CATEGORY_NAME}-min-reviews-filter`,null,cleanList);const maxReviewsFilter=new StorageValue(`${CATEGORY_NAME}-max-reviews-filter`,null,cleanList);const minRatingFilter=new StorageValue(`${CATEGORY_NAME}-min-rating-filter`,4.8,cleanList);const filterEnabled=new StorageValue(`${CATEGORY_NAME}-filter-enabled`,true,cleanList);function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const categoryName=pathElements[2]??"common";return categoryName}const paginatorContent=getFirstElement(PAGINATOR_CONTENT_SELECTOR);const comments=getFirstElement(COMMENTS_SELECTOR);paginatorContent?initListClean():comments?comments.scrollIntoView():appendBadReviewsLinkAndRatingValue();function initListClean(){waitForElement(document,SEARCH_RESULTS_SORT_SELECTOR).then((searchResultsSort=>{appendFilterControlsIfNeeded(searchResultsSort,appendFiltersContainer);const observer=new MutationObserver(cleanList);observer.observe(paginatorContent,{childList:true,subtree:true})}))}function appendFiltersContainer(filtersContainer,parentNode){addGlobalStyle("input[type=number]::-webkit-inner-spin-button,"+"input[type=number]::-webkit-outer-spin-button {"+"    -webkit-appearance: auto;"+"}");filtersContainer.style="display: flex;"+"grid-gap: 15px;"+"margin-top: 14px;";const controlStyle="display: flex;"+"align-items: center;";const inputStyle="margin-left: 5px;"+"border: 2px solid #b3bcc5;"+"border-radius: 6px;"+"padding: 6px 10px;";const textInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 190px;";const numberInputStyle=inputStyle+// eslint-disable-line prefer-template
"width: 90px;";const checkboxInputStyle="margin-left: 5px;"+"width: 25px;"+"height: 25px;";const nameFilterDiv=createNameFilterControl(nameFilter,controlStyle,textInputStyle);const minReviewsDiv=createMinReviewsFilterControl(minReviewsFilter,controlStyle,numberInputStyle);const maxReviewsDiv=createMaxReviewsFilterControl(maxReviewsFilter,controlStyle,numberInputStyle);const minRatingDiv=createMinRatingFilterControl(minRatingFilter,controlStyle,numberInputStyle);const filterEnabledDiv=createEnabledFilterControl(filterEnabled,controlStyle,checkboxInputStyle);filtersContainer.append(nameFilterDiv,minReviewsDiv,maxReviewsDiv,minRatingDiv,filterEnabledDiv);parentNode.append(filtersContainer);parentNode.style="position: sticky;"+"top: 62px;"+"background-color: #fff;"+"z-index: 550;"+"padding-bottom: 11px;"+"margin-bottom: 0;"}function cleanList(){const productCards=getAllElements(PRODUCT_CARDS_SELECTOR,paginatorContent);productCards.forEach((productCard=>{if(!filterEnabled.value){showElement(productCard,"flex");return}const productCardNameWrap=getFirstElement(PRODUCT_CARD_NAME_SELECTOR,productCard);const productCardRatingWrap=getFirstElement(PRODUCT_CARD_RATING_WRAP_SELECTOR,productCard);if(!productCardNameWrap||!productCardRatingWrap){hideElement(productCard);return}const productCardName=productCardNameWrap.innerText;const productCardRatingWrapSpans=getAllElements(":scope > span",productCardRatingWrap,true);const productCardReviewsNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,1,true);const productCardRatingNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,0);productCardNameWrap.title=productCardName;productCardRatingWrap.title=`Рейтинг: ${productCardRatingNumber}
`+`Отзывов: ${productCardReviewsNumber}
`;const conditionToHide=isNotMatchTextFilter(productCardName,nameFilter)||isLessThanFilter(productCardReviewsNumber,minReviewsFilter)||isGreaterThanFilter(productCardReviewsNumber,maxReviewsFilter)||isLessThanFilter(productCardRatingNumber,minRatingFilter);showHideElement(productCard,conditionToHide,"flex")}))}function appendBadReviewsLinkAndRatingValue(){waitForElement(document,PRODUCT_REVIEWS_WRAP_SELECTOR).then((productReviewsWrap=>{if(!productReviewsWrap)return;appendBadReviewsLink(productReviewsWrap);appendRatingValue(productReviewsWrap)}))}function appendBadReviewsLink(productReviewsWrap){const productReviewsLink=getFirstElement("a",productReviewsWrap);if(productReviewsLink){const productReviewsWrapParent=productReviewsWrap.parentNode;const productBadReviewsLinkWrap=createDiv();const productBadReviewsLink=createLink(`${productReviewsLink.href}?sort=score_asc`,thumbsDownIcon,"align-items: center; display: flex;");const productBadReviewsLinkSpan=document.createElement("span");productBadReviewsLinkSpan.style="padding-left: 8px;";productBadReviewsLinkSpan.textContent="Плохие отзывы";productBadReviewsLink.append(productBadReviewsLinkSpan);productBadReviewsLinkWrap.append(productBadReviewsLink);const isInStickyContainer=productReviewsWrapParent.parentNode.matches('[data-widget="stickyContainer"]');if(isInStickyContainer){productBadReviewsLinkWrap.style="margin-top: 10px;";insertAfter(productReviewsWrapParent,productBadReviewsLinkWrap)}else insertAfter(productReviewsWrap,productBadReviewsLinkWrap)}}function appendRatingValue(productReviewsWrap){waitForElement(document,CREATE_REVIEW_BUTTON_SELECTOR).then((createReviewButton=>{const reviewsInfoContainer=createReviewButton.parentNode;waitForElement(reviewsInfoContainer,":scope > div:not([data-widget]").then((ratingInfoContainer=>{const ratingValueContainer=ratingInfoContainer.children[0].children[0].children[1];const ratingValueSpan=ratingValueContainer.children[0];const ratingValue=getRatingValue(ratingValueSpan);if(!ratingValue)return;const starsContainer=productReviewsWrap.children[0].children[0].children[0];const ratingValueDivStyle="margin: 0 4px; color: #005bff;";const ratingValueDiv=createDiv(ratingValue,ratingValueDivStyle);starsContainer.append(ratingValueDiv)}))}))}function getRatingValue(ratingValueSpan){let ratingValue;try{[ratingValue]=removeSpaces(ratingValueSpan.innerHTML).split("/")}catch(e){console.log(`Failed to get ratingValue: ${e.message}`)}return ratingValue}})();