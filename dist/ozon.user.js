// ==UserScript==
// @name         Ozon List Clean
// @description  Remove product cards by filter
// @match        https://www.ozon.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      0.8.69704250
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ozon.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";


const thumbsDownIcon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n'+'<path d="M7.99997 4H17.1919C17.9865 4 18.7058 4.47039 19.0243 5.19836L21.8323 11.6167C21.9429 11.8695 22 12.1424 22 12.4184V13C22 14.1046 21.1045 15 20 15H13.5L14.7066 19.4243C14.8772 20.0498 14.5826 20.7087 14.0027 20.9986V20.9986C13.4204 21.2898 12.7134 21.1274 12.3164 20.6114L8.41472 15.5392C8.14579 15.1896 7.99997 14.7608 7.99997 14.3198V14M7.99997 4H2V14H7.99997M7.99997 4V14" stroke="#005bff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n'+"</svg>";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.-]/g,"")}function removeSpaces(stringValue){return stringValue.replace(/\s/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function insertAfter(existingNode,newNode){existingNode.parentNode.insertBefore(newNode,existingNode.nextSibling)}function hideElement(element){setElementDisplay(element,"none")}function showElement(element,display="block"){setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display="block"){conditionToHide?hideElement(element):showElement(element,display)}function setElementDisplay(element,display){element.style.display=display}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);inputOnChange&&input.addEventListener("change",inputOnChange);style&&(input.style=style);return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function createLink(href,innerHTML=null,style=null){const link=document.createElement("a");link.href=href;innerHTML&&(link.innerHTML=innerHTML);style&&(link.style=style);return link}function getElementInnerNumber(element,cleanText=false){let elementText=element.innerText;cleanText&&(elementText=removeNonNumber(elementText));const elementNumber=+elementText;return elementNumber}function getArrayElementInnerNumber(array,elementIndex,cleanText=false){const element=array[elementIndex];const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function waitForElement(parentNode,selector,timeout=null){return new Promise((resolve=>{const observer=new MutationObserver(mutationCallback);observer.observe(parentNode,{childList:true,subtree:true});let timeoutId=null;timeout&&(timeoutId=setTimeout((()=>{observer.disconnect();console.log(`No element found for selector: ${selector}`);resolve(null)}),timeout));function mutationCallback(){if(parentNode.querySelector(selector)){timeoutId&&clearTimeout(timeoutId);observer.disconnect();resolve(parentNode.querySelector(selector))}}}))}


const storage=localStorage;function getStorageValueOrDefault(key,defaultValue){const localStorageItem=storage.getItem(key);return localStorageItem?JSON.parse(localStorageItem):defaultValue}function setStorageValueFromEvent(event,keyName){const{target}=event;const{type}=target;let valueToSet;if(type==="number")valueToSet=target.value;else{if(type!=="checkbox"){console.log(`Unknown input type: ${type}`);return null}valueToSet=target.checked}storage.setItem(keyName,valueToSet);return valueToSet}


function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,inputOnChange,controlStyle="",inputStyle=""){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,isChecked,inputOnChange,controlStyle="",inputStyle=""){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(inputOnChange,inputStyle,isChecked);filterControl.append(input);return filterControl}function createMinRatingFilterControl(inputValue,inputOnChange,controlStyle="",inputStyle=""){return createFilterControlNumber("Минимальный рейтинг: ",inputValue,"0.1","3.0","5.0",inputOnChange,controlStyle,inputStyle)}function createMinReviewsFilterControl(inputValue,inputOnChange,controlStyle="",inputStyle=""){return createFilterControlNumber("Минимально отзывов: ",inputValue,"1","1","999999",inputOnChange,controlStyle,inputStyle)}function createEnabledFilterControl(isChecked,inputOnChange,controlStyle="",inputStyle=""){return createFilterControlCheckbox("Вкл: ",isChecked,inputOnChange,controlStyle,inputStyle)}function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer)return;filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


const CATEGORY_NAME=getCategoryName();const MIN_REVIEWS_STORAGE_KEY=`${CATEGORY_NAME}-min-reviews-filter`;const MIN_RATING_STORAGE_KEY=`${CATEGORY_NAME}-min-rating-filter`;const FILTER_ENABLED_STORAGE_KEY=`${CATEGORY_NAME}-filter-enabled`;const PAGINATOR_CONTENT_SELECTOR="#paginatorContent";const PRODUCT_REVIEWS_WRAP_SELECTOR='[data-widget="webReviewProductScore"]';const COMMENTS_SELECTOR="#comments";const SEARCH_RESULTS_SORT_SELECTOR='[data-widget="searchResultsSort"]';const SEARCH_RESULT_SELECTOR=".widget-search-result-container";const PRODUCT_CARD_RATING_WRAP_SELECTOR=".tsBodyMBold";const CREATE_REVIEW_BUTTON_SELECTOR='[data-widget="createReviewButton"]';const MIN_REVIEWS=50;const MIN_RATING=4.8;const FILTER_ENABLED=true;let minReviewsValue=getStorageValueOrDefault(MIN_REVIEWS_STORAGE_KEY,MIN_REVIEWS);let minRatingValue=getStorageValueOrDefault(MIN_RATING_STORAGE_KEY,MIN_RATING);let filterEnabledChecked=getStorageValueOrDefault(FILTER_ENABLED_STORAGE_KEY,FILTER_ENABLED);function getCategoryName(){const{pathname}=window.location;const pathElements=pathname.split("/");const categoryName=pathElements[2]??"common";return categoryName}const paginatorContent=getFirstElement(PAGINATOR_CONTENT_SELECTOR);const comments=getFirstElement(COMMENTS_SELECTOR);paginatorContent?initListClean():comments?comments.scrollIntoView():appendBadReviewsLinkAndRatingValue();function initListClean(){waitForElement(document,SEARCH_RESULTS_SORT_SELECTOR).then((searchResultsSort=>{appendFilterControlsIfNeeded(searchResultsSort,appendFiltersContainer);setInterval(cleanList,100)}))}function appendFiltersContainer(filtersContainer,parentNode){filtersContainer.style="display: flex;"+"grid-gap: 15px;"+"margin: 14px 0px 0px 15px;";const controlStyle="display: flex;"+"align-items: center;";const numberInputStyle="border: 2px solid #b3bcc5;"+"border-radius: 6px;"+"padding: 6px 10px;"+"width: 90px;";const checkboxInputStyle="width: 25px;"+"height: 25px;";const minReviewsDiv=createMinReviewsFilterControl(minReviewsValue,updateMinReviewsValue,controlStyle,numberInputStyle);const minRatingDiv=createMinRatingFilterControl(minRatingValue,updateMinRatingValue,controlStyle,numberInputStyle);const filterEnabledDiv=createEnabledFilterControl(filterEnabledChecked,updateFilterEnabledValue,controlStyle,checkboxInputStyle);filtersContainer.append(minReviewsDiv,minRatingDiv,filterEnabledDiv);parentNode.append(filtersContainer)}function updateMinReviewsValue(e){minReviewsValue=setStorageValueFromEvent(e,MIN_REVIEWS_STORAGE_KEY)}function updateMinRatingValue(e){minRatingValue=setStorageValueFromEvent(e,MIN_RATING_STORAGE_KEY)}function updateFilterEnabledValue(e){filterEnabledChecked=setStorageValueFromEvent(e,FILTER_ENABLED_STORAGE_KEY)}function cleanList(){const searchResultContainer=getFirstElement(SEARCH_RESULT_SELECTOR,document,true);const productCardsWrap=getFirstElement(":scope > div",searchResultContainer,true);const productCards=getAllElements(":scope > div",productCardsWrap);productCards.forEach((productCard=>{if(!filterEnabledChecked){showElement(productCard);return}const productCardRatingWrap=getFirstElement(PRODUCT_CARD_RATING_WRAP_SELECTOR,productCard);if(!productCardRatingWrap){hideElement(productCard);return}const productCardRatingWrapSpans=getAllElements(":scope > span",productCardRatingWrap,true);const productCardReviewsNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,1);const productCardRatingNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,0);const conditionToHide=productCardReviewsNumber<minReviewsValue||productCardRatingNumber<minRatingValue;showHideElement(productCard,conditionToHide,"flex")}))}function appendBadReviewsLinkAndRatingValue(){waitForElement(document,PRODUCT_REVIEWS_WRAP_SELECTOR,1500).then((productReviewsWrap=>{if(!productReviewsWrap)return;appendBadReviewsLink(productReviewsWrap);appendRatingValue(productReviewsWrap)}))}function appendBadReviewsLink(productReviewsWrap){const productReviewsLink=getFirstElement("a",productReviewsWrap);if(productReviewsLink){const productReviewsWrapParent=productReviewsWrap.parentNode;const productBadReviewsLinkWrap=createDiv();const productBadReviewsLink=createLink(`${productReviewsLink.href}?sort=score_asc`,thumbsDownIcon,"align-items: center; display: flex;");const productBadReviewsLinkSpan=document.createElement("span");productBadReviewsLinkSpan.style="padding-left: 8px;";productBadReviewsLinkSpan.textContent="Плохие отзывы";productBadReviewsLink.append(productBadReviewsLinkSpan);productBadReviewsLinkWrap.append(productBadReviewsLink);const isInStickyContainer=productReviewsWrapParent.parentNode.matches('[data-widget="stickyContainer"]');if(isInStickyContainer){productBadReviewsLinkWrap.style="margin-top: 10px;";insertAfter(productReviewsWrapParent,productBadReviewsLinkWrap)}else insertAfter(productReviewsWrap,productBadReviewsLinkWrap)}}function appendRatingValue(productReviewsWrap){waitForElement(document,CREATE_REVIEW_BUTTON_SELECTOR).then((createReviewButton=>{const reviewsInfoContainer=createReviewButton.parentNode;waitForElement(reviewsInfoContainer,":scope > div:not([data-widget]",2e3).then((ratingInfoContainer=>{const ratingValueContainer=ratingInfoContainer.children[0].children[0].children[1];const ratingValue=getRatingValue(ratingValueContainer);if(!ratingValue)return;const starsContainer=productReviewsWrap.children[0].children[0].children[0];const ratingValueDivStyle="margin: 0 4px; color: #005bff;";const ratingValueDiv=createDiv(ratingValue,ratingValueDivStyle);starsContainer.append(ratingValueDiv)}))}))}function getRatingValue(ratingValueContainer){let ratingValue;try{[ratingValue]=removeSpaces(ratingValueContainer.innerText).split("/")}catch(e){console.log(`Failed to get ratingValue: ${e.message}`)}return ratingValue}})();