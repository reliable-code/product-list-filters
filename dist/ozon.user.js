// ==UserScript==
// @name         Ozon List Clean
// @description  Remove product cards by filter
// @grant        GM_deleteValue
// @grant        GM_listValues
// @grant        GM_addValueChangeListener
// @grant        GM_setValue
// @grant        GM_getValue
// @match        https://www.ozon.ru/*
// @namespace    https://github.com/reliable-code/product-list-filters
// @version      1.3.73185005
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ozon.ru
// @author       reliable-code
// ==/UserScript==

(()=>{"use strict";function removeNonNumber(stringValue){return stringValue.replace(/[^\d.,-]/g,"")}


function getFirstElement(selector,parentNode=document,logNotFound=false){const element=parentNode.querySelector(selector);logNotFound&&!element&&console.log(`No element found for selector: ${selector}`);return element}function getAllElements(selector,parentNode=document,logNotFound=false){const elements=parentNode.querySelectorAll(selector);logNotFound&&!elements.length&&console.log(`No elements found for selector: ${selector}`);return elements}function insertAfter(existingNode,newNode){existingNode.parentNode.insertBefore(newNode,existingNode.nextSibling)}function hideElement(element){setElementDisplayAttributeIfNeeded(element);setElementDisplay(element,"none")}function showElement(element,display){display=display||getElementDisplay(element);setElementDisplay(element,display)}function showHideElement(element,conditionToHide,display){if(conditionToHide)hideElement(element);else{display=display||getElementDisplay(element);showElement(element,display)}}function setElementDisplay(element,display){element.style.display=display}function getElementDisplay(element){setElementDisplayAttributeIfNeeded(element);return element.getAttribute("display")}function setElementDisplayAttributeIfNeeded(element){if(element.hasAttribute("display"))return;const{display}=getComputedStyle(element);element.setAttribute("display",display)}function getElementInnerNumber(element,cleanText=false,replaceComma=false,defaultValue=null){if(!element){if(defaultValue!==null)return defaultValue;console.log("No element found")}const elementText=element.innerText;return parseNumber(elementText,cleanText,replaceComma)}function getArrayElementInnerNumber(array,elementIndex,cleanText=false){const element=array[elementIndex];const elementNumber=getElementInnerNumber(element,cleanText);return elementNumber}function getNodeInnerNumber(node,cleanText=false,replaceComma=false){const nodeText=node.textContent;return parseNumber(nodeText,cleanText,replaceComma)}function parseNumber(text,cleanText,replaceComma){cleanText&&(text=removeNonNumber(text));replaceComma&&(text=text.replace(",","."));const number=+text;return number}function waitForElement(parentNode,selector,timeout=null){return new Promise((resolve=>{const existingElement=parentNode.querySelector(selector);if(existingElement){resolve(existingElement);return}const observer=new MutationObserver(mutationCallback);observer.observe(parentNode,{childList:true,subtree:true});let timeoutId=null;timeout&&(timeoutId=setTimeout((()=>{observer.disconnect();console.log(`No element found for selector: ${selector}`);resolve(null)}),timeout));function mutationCallback(){if(parentNode.querySelector(selector)){timeoutId&&clearTimeout(timeoutId);observer.disconnect();resolve(parentNode.querySelector(selector))}}}))}function debounce(func,wait=250){let timeoutId;return(...args)=>{clearTimeout(timeoutId);timeoutId=setTimeout((()=>func(...args)),wait)}}function addGlobalStyle(css){const style=document.createElement("style");style.type="text/css";style.textContent=css;document.head.appendChild(style)}function getInputValueFromEvent(event){const{target}=event;const{type}=target;switch(type){case"text":return`"${target.value}"`;case"number":return target.value;case"checkbox":return target.checked;default:console.log(`Unknown input type: ${type}`);return null}}function parseValue(value){return value===""?null:JSON.parse(value)}


class InputValueBase{constructor(value,onChange){this.value=value;this.onChange=onChange}onChangeIfDefined=()=>{this.onChange&&this.onChange()}}


const setStorageValue=window.GM_setValue;const getStorageValue=window.GM_getValue;const addStorageValueListener=window.GM_addValueChangeListener;class StoredInputValue extends InputValueBase{constructor(storageKey,defaultValue=null,onChange=null){super(getStorageValue(storageKey,defaultValue),onChange);this.storageKey=storageKey}updateValueFromEvent=event=>{const newValue=getInputValueFromEvent(event);const newParsedValue=parseValue(newValue);if(this.value===newParsedValue)return;setStorageValue(this.storageKey,newParsedValue);this.value=newParsedValue;this.onChangeIfDefined()}}


class DatedValue{constructor(value,date=(new Date).toLocaleDateString()){this.value=value;this.date=date}}


const thumbsDownIcon='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">'+'<path d="M8 14V4M8 14L4 14V4.00002L8 4M8 14L13.1956 20.0615C13.6886 20.6367 14.4642 20.884 15.1992 20.7002L15.2467 20.6883C16.5885 20.3529 17.1929 18.7894 16.4258 17.6387L14 14H18.5604C19.8225 14 20.7691 12.8454 20.5216 11.6078L19.3216 5.60779C19.1346 4.67294 18.3138 4.00002 17.3604 4.00002L8 4" stroke="#001a3499" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'+"</svg>";const heartStrikeDislikeIcon='<svg fill="#001a3499" width="16" height="16" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">'+'<path d="M417.84,448a15.94,15.94,0,0,1-11.35-4.72L40.65,75.26A16,16,0,0,1,63.35,52.7l365.83,368A16,16,0,0,1,417.84,448Z"/><path d="M364.92,80c-48.09,0-80,29.55-96.92,51-16.88-21.48-48.83-51-96.92-51a107.37,107.37,0,0,0-31,4.55L168,112c22.26,0,45.81,9,63.94,26.67a123,123,0,0,1,21.75,28.47,16,16,0,0,0,28.6,0,123,123,0,0,1,21.77-28.51C322.19,121,342.66,112,364.92,112c43.15,0,78.62,36.33,79.07,81,.54,53.69-22.75,99.55-57.38,139.52l22.63,22.77c3-3.44,5.7-6.64,8.14-9.6,40-48.75,59.15-98.8,58.61-153C475.37,130.52,425.54,80,364.92,80Z"/><path d="M268,432C180.38,372.51,91,297.6,92,193a83.69,83.69,0,0,1,2.24-18.39L69,149.14a115.1,115.1,0,0,0-9,43.49c-.54,54.22,18.63,104.27,58.61,153,18.77,22.87,52.8,59.45,131.39,112.8a31.84,31.84,0,0,0,36,0c20.35-13.81,37.7-26.5,52.58-38.11l-22.66-22.81C300.25,409.6,284.09,421.05,268,432Z"/>'+"</svg>";


class PriceData{constructor(current,lowest,highest){this.current=current;this.lowest=lowest;this.highest=highest}}


function getURLPathElement(position,defaultValue="common",logResult=false){const{pathname}=window.location;return getPathnameElement(pathname,position,defaultValue,logResult)}function getPathnameElement(pathname,position,defaultValue,logResult=false){const pathElements=pathname.split("/");const pathElement=pathElements[position]||defaultValue;logResult&&console.log(`Pathname element: ${pathElement}`);return pathElement}function getURLPathElementEnding(position,defaultValue="common",logResult=false){const pathElement=getURLPathElement(position,"",logResult);return getPathElementEnding(pathElement,defaultValue,logResult)}function getPathElementEnding(pathElement,defaultValue,logResult){if(!pathElement)return defaultValue;const pathElementEnding=pathElement.split("-").at(-1);logResult&&console.log(`Pathname element ending: ${pathElementEnding}`);return pathElementEnding}function getPathnameElementEnding(pathname,position,defaultValue="common",logResult=false){const pathElement=getPathnameElement(pathname,position,"",logResult);return getPathElementEnding(pathElement,defaultValue,logResult)}function somePathElementEquals(searchString){const pathElements=window.location.pathname.split("/");return pathElements.some((pathElement=>pathElement===searchString))}


function createTextInput(inputOnChange,inputStyle,inputValue){const input=createInput("text",inputOnChange,inputStyle);input.value=inputValue;return input}function createNumberInput(inputOnChange,inputStyle,inputValue,inputStep,inputMinValue,inputMaxValue){const input=createInput("number",inputOnChange,inputStyle);input.value=inputValue;input.step=inputStep;input.min=inputMinValue;input.max=inputMaxValue;return input}function createCheckboxInput(inputOnChange,inputStyle,isChecked){const input=createInput("checkbox",inputOnChange,inputStyle);input.checked=isChecked;return input}function createInput(type=null,inputOnChange=null,style=null){const input=document.createElement("input");type&&(input.type=type);if(inputOnChange){input.addEventListener("keyup",debounce(inputOnChange,200));input.addEventListener("change",debounce(inputOnChange,100))}style&&(input.style=style);return input}function createDiv(textContent=null,style=null){const div=document.createElement("div");textContent&&(div.textContent=textContent);style&&(div.style=style);return div}function createSpan(textContent=null,style=null){const span=document.createElement("span");textContent&&(span.textContent=textContent);style&&(span.style=style);return span}function createLink(href=null,innerHTML=null,style=null){const link=document.createElement("a");href&&(link.href=href);innerHTML&&(link.innerHTML=innerHTML);style&&(link.style=style);return link}


const PRODUCT_CARDS_SELECTOR=".widget-search-result-container > div > div.tile-root";const SEARCH_RESULTS_SORT_SELECTOR='[data-widget="searchResultsSort"]';const PRODUCT_CARD_NAME_SELECTOR=".tsBody500Medium";const INPUT_STYLE="margin-left: 5px;"+"border: 2px solid #b3bcc5;"+"border-radius: 6px;"+"padding: 6px 10px;";const NUMBER_INPUT_STYLE=INPUT_STYLE+// eslint-disable-line prefer-template
"width: 75px;";const TEXT_INPUT_STYLE=INPUT_STYLE+// eslint-disable-line prefer-template
"width: 180px;";const CONTROL_STYLE="display: flex;"+"align-items: center;";const CHECKBOX_INPUT_STYLE="margin-left: 5px;"+"width: 25px;"+"height: 25px;";function getProductArticleFromLink(productCardLink){const productCardLinkHref=productCardLink.getAttribute("href");return getPathnameElementEnding(productCardLinkHref,2)}function appendPriceHistory(priceContainer,productArticle){const priceSpan=getFirstElement("span",priceContainer);const currentPriceValue=getNodeInnerNumber(priceSpan,true);const lowestPriceValue=updateAndAppendStoredPriceValue(productArticle,"lp",(storedPrice=>currentPriceValue<=storedPrice.value),currentPriceValue,"Мин. цена","#d6f5b1",priceContainer);const highestPriceValue=updateAndAppendStoredPriceValue(productArticle,"hp",(storedPrice=>currentPriceValue>=storedPrice.value),currentPriceValue,"Макс. цена","#fed2ea",priceContainer);return new PriceData(currentPriceValue,lowestPriceValue,highestPriceValue)}function updateAndAppendStoredPriceValue(productArticle,postfix,compareCondition,currentPriceValue,label,color,priceContainer){const storageKey=`${productArticle}-${postfix}`;let storedPrice=getStorageValue(storageKey);if(currentPriceValue){if(!storedPrice||compareCondition(storedPrice)){const currentPrice=new DatedValue(currentPriceValue);setStorageValue(storageKey,currentPrice);storedPrice=currentPrice}}else if(!storedPrice)return 0;appendStoredPriceValue(label,storedPrice,color,priceContainer);return storedPrice.value}function appendStoredPriceValue(label,storedPrice,color,priceContainer){const divText=`${label}: `;const divStyle="color: #000;"+"font-size: 16px;"+"padding: 17px 0px 7px;";const storedPriceContainer=createDiv(divText,divStyle);const spanText=`${storedPrice.value.toLocaleString()} ₽`;const spanStyle="font-weight: bold;"+"padding: 6px 12px;"+"border-radius: 8px;"+"cursor: pointer;"+`background: ${color};`;const storedPriceSpan=createSpan(spanText,spanStyle);storedPriceSpan.addEventListener("mouseover",(()=>{storedPriceSpan.textContent=storedPrice.date}));storedPriceSpan.addEventListener("mouseleave",(()=>{storedPriceSpan.textContent=spanText}));storedPriceContainer.append(storedPriceSpan);priceContainer.parentNode.append(storedPriceContainer)}function createDislikeButton(onClick,needLabel=true){const style="display: inline-flex;"+"align-items: center;"+"margin-left: auto;"+"color: rgba(0, 26, 52, 0.6);"+"cursor: pointer;";const productDislikeButton=createLink(null,heartStrikeDislikeIcon,style);productDislikeButton.onclick=()=>{window.confirm("Выставить низкий рейтинг?")&&onClick()};if(needLabel){const productDislikeButtonSpan=createSpan("Дизлайк","padding-left: 8px;");productDislikeButton.append(productDislikeButtonSpan)}return productDislikeButton}function setStoredRatingValue(productArticle,ratingValue){setStorageValue(`${productArticle}-rate`,ratingValue);setStorageValue("last-rate-update",Date.now())}function getStoredRatingValue(productArticle){return getStorageValue(`${productArticle}-rate`)}function setCommonFiltersContainerStyles(filtersContainer,parentNode){addInputSpinnerButtons();filtersContainer.style="display: flex;"+"flex-flow: wrap;"+"grid-gap: 15px;"+"min-width: 1250px;";parentNode.style="position: sticky;"+"top: 2px;"+"background-color: #fff;"+"z-index: 2;"+"padding-bottom: 11px;"+"margin-bottom: 0;"+"gap: 15px;"}function addInputSpinnerButtons(){addGlobalStyle("input[type=number]::-webkit-inner-spin-button,"+"input[type=number]::-webkit-outer-spin-button {"+"    -webkit-appearance: auto;"+"}")}function getFirstProductCardsWrap(){return getFirstElement(".widget-search-result-container").firstChild}function moveProductCardToFirstWrapIfNeeded(productCard,firstProductCardsWrap){if(productCard.parentNode===firstProductCardsWrap)return;firstProductCardsWrap.appendChild(productCard)}


function appendFilterControlsIfNeeded(parentNode,appendFiltersContainerFunc,force=false,filtersContainerId="customFiltersContainer"){let filtersContainer=getFirstElement(`#${filtersContainerId}`,parentNode);if(filtersContainer){if(!force)return;filtersContainer.remove()}filtersContainer=createDiv();filtersContainer.id=filtersContainerId;appendFiltersContainerFunc(filtersContainer,parentNode)}


function isNotMatchTextFilter(parameterValue,filter){return!isMatchTextFilter(parameterValue,filter)}function isMatchTextFilter(parameterValue,filter){if(!filter.value)return true;const comparedString=parameterValue.toLowerCase();const searchStrings=filter.value.toLowerCase().split(",").map((searchString=>searchString.trim()));const{include:includeSearchStrings,notInclude:notIncludeSearchStrings}=searchStrings.reduce(((result,searchString)=>{if(searchString.startsWith("!")){const notIncludeSearchString=searchString.substring(1);notIncludeSearchString.length&&result.notInclude.push(notIncludeSearchString)}else result.include.push(searchString);return result}),{include:[],notInclude:[]});return includeSearchStrings.every((searchString=>comparedString.includes(searchString)))&&notIncludeSearchStrings.every((searchString=>!comparedString.includes(searchString)))}function isLessThanFilter(parameterValue,filter){return filter.value&&parameterValue<filter.value}function isGreaterThanFilter(parameterValue,filter){return filter.value&&parameterValue>filter.value}


function createFilterControlText(titleText,inputValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createTextInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value);filterControl.append(input);return filterControl}function createFilterControlNumber(titleText,inputValue,inputStep,inputMinValue,inputMaxValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createNumberInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value,inputStep,inputMinValue,inputMaxValue);filterControl.append(input);return filterControl}function createFilterControlCheckbox(titleText,inputValue,controlStyle=null,inputStyle=null){const filterControl=createDiv(titleText,controlStyle);const input=createCheckboxInput(inputValue.updateValueFromEvent,inputStyle,inputValue.value);filterControl.append(input);return filterControl}function createNameFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlText("Содержит: ",inputValue,controlStyle,inputStyle)}function createMinRatingFilterControl(inputValue,controlStyle=null,inputStyle=null,inputStep=.1){return createFilterControlNumber("Мин. рейтинг: ",inputValue,inputStep,3,5,controlStyle,inputStyle)}function createMinReviewsFilterControl(inputValue,controlStyle=null,inputStyle=null){return createReviewsFilterControl("Мин. отзывов: ",inputValue,controlStyle,inputStyle)}function createMaxReviewsFilterControl(inputValue,controlStyle=null,inputStyle=null){return createReviewsFilterControl("Макс. отзывов: ",inputValue,controlStyle,inputStyle)}function createReviewsFilterControl(titleText,inputValue,controlStyle=null,inputStyle=null){return createFilterControlNumber(titleText,inputValue,"1","1","999999",controlStyle,inputStyle)}function createPriceFilterControlBase(titleText,inputValue,controlStyle,inputStyle,inputStep){return createFilterControlNumber(titleText,inputValue,inputStep,"0","1000000",controlStyle,inputStyle)}function createMaxPriceFilterControl(inputValue,controlStyle=null,inputStyle=null,inputStep="250"){return createPriceFilterControlBase("Макс. цена: ",inputValue,controlStyle,inputStyle,inputStep)}function createNoRatingFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Без рейтинга: ",inputValue,controlStyle,inputStyle)}function createEnabledFilterControl(inputValue,controlStyle=null,inputStyle=null){return createFilterControlCheckbox("Вкл: ",inputValue,controlStyle,inputStyle)}


const PAGINATOR_SELECTOR='[data-widget="paginator"]';const APPEND_STORED_PRICE_VALUES_PASSED_ATTR="appendStoredPriceValuesPassed";const CURRENT_PRICE_ATTR="currentPrice";const LOWEST_PRICE_ATTR="lowestPrice";const GOOD_PRICE_ATTR="goodPrice";const nameFilter=new StoredInputValue("favorites-name-filter",null,processList);const bestPriceFilter=new StoredInputValue("best-price-filter",false,processList);const onPriceTolerancePercentChange=()=>processList(true);const priceTolerancePercent=new StoredInputValue("price-tolerance-percent",3,onPriceTolerancePercentChange);const filterEnabled=new StoredInputValue("favorites-filter-enabled",true,processList);function initFavoritesMods(){waitForElement(document,SEARCH_RESULTS_SORT_SELECTOR).then((searchResultsSort=>{appendFilterControlsIfNeeded(searchResultsSort,appendFiltersContainer);const paginator=getFirstElement(PAGINATOR_SELECTOR);processList();const observer=new MutationObserver(debounce(processList));observer.observe(paginator,{childList:true,subtree:true})}))}function appendFiltersContainer(filtersContainer,parentNode){setCommonFiltersContainerStyles(filtersContainer,parentNode);const nameFilterDiv=createNameFilterControl(nameFilter,CONTROL_STYLE,TEXT_INPUT_STYLE);const bestPriceDiv=createFilterControlCheckbox("Лучшая цена: ",bestPriceFilter,CONTROL_STYLE,CHECKBOX_INPUT_STYLE);const priceTolerancePercentDiv=createFilterControlNumber("Допуск цены, %: ",priceTolerancePercent,1,0,100,CONTROL_STYLE,NUMBER_INPUT_STYLE);const filterEnabledDiv=createEnabledFilterControl(filterEnabled,CONTROL_STYLE,CHECKBOX_INPUT_STYLE);filtersContainer.append(nameFilterDiv,bestPriceDiv,priceTolerancePercentDiv,filterEnabledDiv);parentNode.append(filtersContainer)}function processList(priceTolerancePercentChanged=false){const productCards=getAllElements(PRODUCT_CARDS_SELECTOR);const firstProductCardsWrap=getFirstProductCardsWrap();productCards.forEach((productCard=>{if(!filterEnabled.value){showElement(productCard);return}moveProductCardToFirstWrapIfNeeded(productCard,firstProductCardsWrap);appendStoredPriceValuesIfNeeded(productCard);if(priceTolerancePercentChanged&&productCard.hasAttribute(CURRENT_PRICE_ATTR)&&productCard.hasAttribute(LOWEST_PRICE_ATTR)){const priceContainerWrap=getPriceContainer(productCard).parentNode;checkIfGoodPrice(priceContainerWrap,productCard)}const productCardNameWrap=getFirstElement(PRODUCT_CARD_NAME_SELECTOR,productCard);if(!productCardNameWrap){hideElement(productCard);return}const productCardName=productCardNameWrap.innerText;productCardNameWrap.title=productCardName;const isNotMatchBestPriceFilter=!!bestPriceFilter.value&&!productCard.hasAttribute(GOOD_PRICE_ATTR);const conditionToHide=isNotMatchTextFilter(productCardName,nameFilter)||isNotMatchBestPriceFilter;showHideElement(productCard,conditionToHide)}))}function appendStoredPriceValuesIfNeeded(productCard){if(productCard.hasAttribute(APPEND_STORED_PRICE_VALUES_PASSED_ATTR))return;const additionalInfoDiv=getFirstElement(".tsBodyControl400Small",productCard);if(additionalInfoDiv){const notInStock=additionalInfoDiv.innerText==="Нет в наличии";if(notInStock){productCard.setAttribute(APPEND_STORED_PRICE_VALUES_PASSED_ATTR,"");return}}const priceContainer=getPriceContainer(productCard);const priceContainerWrap=priceContainer.parentNode;appendStoredPriceValues(priceContainer,productCard,priceContainerWrap);checkIfGoodPrice(priceContainerWrap,productCard)}function getPriceContainer(productCard){return productCard.children[0].children[1].children[0].children[0]}function appendStoredPriceValues(priceContainer,productCard,priceContainerWrap){const productCardLink=getFirstElement("a",productCard);if(!productCardLink)return;const productArticle=getProductArticleFromLink(productCardLink);const priceData=appendPriceHistory(priceContainer,productArticle);productCard.setAttribute(CURRENT_PRICE_ATTR,priceData.current);productCard.setAttribute(LOWEST_PRICE_ATTR,priceData.lowest);priceContainerWrap.style.display="block";productCard.setAttribute(APPEND_STORED_PRICE_VALUES_PASSED_ATTR,"")}function checkIfGoodPrice(priceContainerWrap,productCard){const currentPrice=productCard.getAttribute(CURRENT_PRICE_ATTR);const lowestPrice=productCard.getAttribute(LOWEST_PRICE_ATTR);const priceToleranceFactor=1+priceTolerancePercent.value/100;const goodPrice=lowestPrice*priceToleranceFactor;if(currentPrice<=goodPrice){priceContainerWrap.style.border="3px solid rgb(214, 245, 177)";priceContainerWrap.style.borderRadius="14px";priceContainerWrap.style.padding="4px 10px 6px";priceContainerWrap.style.marginBottom="5px";priceContainerWrap.style.width="-webkit-fill-available";productCard.setAttribute(GOOD_PRICE_ATTR,"")}else{const stylePropertiesToRemove=["border","borderRadius","padding","marginBottom","width"];stylePropertiesToRemove.forEach((property=>priceContainerWrap.style.removeProperty(property)));productCard.removeAttribute(GOOD_PRICE_ATTR)}}


const PAGINATOR_CONTENT_SELECTOR="#paginatorContent";const paginatorContent=getFirstElement(PAGINATOR_CONTENT_SELECTOR);const PRODUCT_CARD_PRICE_SELECTOR=".tsHeadline500Medium";const PRODUCT_CARD_RATING_WRAP_SELECTOR=".tsBodyMBold";const DISLIKE_BUTTON_ADDED_ATTR="dislikeButtonAdded";const CATEGORY_NAME=getURLPathElementEnding(2);const productList_nameFilter=new StoredInputValue(`${CATEGORY_NAME}-name-filter`,null,cleanList);const minReviewsFilter=new StoredInputValue(`${CATEGORY_NAME}-min-reviews-filter`,null,cleanList);const maxReviewsFilter=new StoredInputValue(`${CATEGORY_NAME}-max-reviews-filter`,null,cleanList);const minRatingFilter=new StoredInputValue(`${CATEGORY_NAME}-min-rating-filter`,4.8,cleanList);const noRatingFilter=new StoredInputValue(`${CATEGORY_NAME}-no-rating-filter`,false,cleanList);const maxPriceFilter=new StoredInputValue(`${CATEGORY_NAME}-max-price-filter`,null,cleanList);const productList_filterEnabled=new StoredInputValue(`${CATEGORY_NAME}-filter-enabled`,true,cleanList);const nameLinesNumber=new StoredInputValue("name-lines-number",2,cleanList);
// const rowCardsNumber =
//     new StoredInputValue('row-cards-number', 4, cleanList);
function initProductListMods(){waitForElement(document,SEARCH_RESULTS_SORT_SELECTOR).then((searchResultsSort=>{appendFilterControlsIfNeeded(searchResultsSort,productList_appendFiltersContainer);addStorageValueListener("last-rate-update",cleanList);cleanList();const observer=new MutationObserver(debounce(cleanList,150));observer.observe(paginatorContent,{childList:true,subtree:true})}))}function productList_appendFiltersContainer(filtersContainer,parentNode){setCommonFiltersContainerStyles(filtersContainer,parentNode);const nameFilterDiv=createNameFilterControl(productList_nameFilter,CONTROL_STYLE,TEXT_INPUT_STYLE);const minReviewsDiv=createMinReviewsFilterControl(minReviewsFilter,CONTROL_STYLE,NUMBER_INPUT_STYLE);const maxReviewsDiv=createMaxReviewsFilterControl(maxReviewsFilter,CONTROL_STYLE,NUMBER_INPUT_STYLE);const minRatingDiv=createMinRatingFilterControl(minRatingFilter,CONTROL_STYLE,NUMBER_INPUT_STYLE);const noRatingDiv=createNoRatingFilterControl(noRatingFilter,CONTROL_STYLE,CHECKBOX_INPUT_STYLE);const maxPriceDiv=createMaxPriceFilterControl(maxPriceFilter,CONTROL_STYLE,NUMBER_INPUT_STYLE,"25");const filterEnabledDiv=createEnabledFilterControl(productList_filterEnabled,CONTROL_STYLE,CHECKBOX_INPUT_STYLE);const nameLinesNumberDiv=createFilterControlNumber("Строк: ",nameLinesNumber,1,1,10,CONTROL_STYLE,NUMBER_INPUT_STYLE);filtersContainer.append(nameFilterDiv,minReviewsDiv,maxReviewsDiv,minRatingDiv,noRatingDiv,maxPriceDiv,filterEnabledDiv,nameLinesNumberDiv);parentNode.append(filtersContainer)}function cleanList(){const productCards=getAllElements(PRODUCT_CARDS_SELECTOR,paginatorContent);const productCardsLength=productCards.length;warnIfListNotFull(productCardsLength);const firstProductCardsWrap=getFirstProductCardsWrap();let showCounter=0;productCards.forEach((productCard=>{if(!productList_filterEnabled.value){showElement(productCard);showCounter+=1;return}moveProductCardToFirstWrapIfNeeded(productCard,firstProductCardsWrap);const productCardLink=getFirstElement("a",productCard);if(!productCardLink){hideElement(productCard);return}const productArticle=getProductArticleFromLink(productCardLink);const productCardNameWrap=getFirstElement(PRODUCT_CARD_NAME_SELECTOR,productCard);const productCardPriceWrap=getFirstElement(PRODUCT_CARD_PRICE_SELECTOR,productCard);if(!productCardNameWrap||!productCardPriceWrap){hideElement(productCard);return}productCardNameWrap.parentNode.style.webkitLineClamp=nameLinesNumber.value;const productCardPriceNumber=getElementInnerNumber(productCardPriceWrap,true);const productCardRatingWrap=getFirstElement(PRODUCT_CARD_RATING_WRAP_SELECTOR,productCard);let productCardReviewsNumber;let productCardRatingNumber;if(productCardRatingWrap){const productCardRatingWrapSpans=getAllElements(":scope > span",productCardRatingWrap,true);productCardReviewsNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,1,true);const storedRatingValue=getStoredRatingValue(productArticle);if(storedRatingValue){productCardRatingNumber=storedRatingValue;productCardRatingWrapSpans[0].children[1].textContent=storedRatingValue.toString().padEnd(5)}else productCardRatingNumber=getArrayElementInnerNumber(productCardRatingWrapSpans,0);appendProductDislikeButtonIfNeeded(productCardRatingWrap,productArticle)}else{const anyRatingFilterHasValue=minReviewsFilter.value||maxReviewsFilter.value||minRatingFilter.value;if(anyRatingFilterHasValue&&!noRatingFilter.value){hideElement(productCard);return}}const productCardName=productCardNameWrap.innerText;productCardNameWrap.title=productCardName;const conditionToHide=isNotMatchTextFilter(productCardName,productList_nameFilter)||isLessThanFilter(productCardReviewsNumber,minReviewsFilter)||isGreaterThanFilter(productCardReviewsNumber,maxReviewsFilter)||isLessThanFilter(productCardRatingNumber,minRatingFilter)||isGreaterThanFilter(productCardPriceNumber,maxPriceFilter);showHideElement(productCard,conditionToHide);conditionToHide||(showCounter+=1)}));console.log(`Отображено: ${showCounter} из ${productCardsLength}`)}function warnIfListNotFull(productCardsLength,defaultLength=36){if(productCardsLength===defaultLength||window.location.search.includes("text"))return;console.warn(`Озон предоставил ${productCardsLength} позиций из ${defaultLength}`)}function appendProductDislikeButtonIfNeeded(productCardRatingWrap,productArticle){if(productCardRatingWrap.hasAttribute(DISLIKE_BUTTON_ADDED_ATTR))return;productCardRatingWrap.style="display: flex; width: 100%";const dislikeButton=createDislikeButton((()=>dislikeProductOnProductList(productArticle)),false);productCardRatingWrap.append(dislikeButton);productCardRatingWrap.setAttribute(DISLIKE_BUTTON_ADDED_ATTR,"")}function dislikeProductOnProductList(productArticle){setStoredRatingValue(productArticle,1);cleanList()}


const PRODUCT_REVIEWS_WRAP_SELECTOR='[data-widget="webSingleProductScore"]';function initProductPageMods(){waitForElement(document,`${PRODUCT_REVIEWS_WRAP_SELECTOR}`).then((productReviewsWrap=>{if(!productReviewsWrap)return;appendDislikeButton(productReviewsWrap);appendBadReviewsLink(productReviewsWrap);appendRatingValue(getStarsContainer(productReviewsWrap))}));initAppendPriceHistory();skipFirstGalleryVideo();extendProductNameMaxHeight()}function appendDislikeButton(productReviewsWrap){const productDislikeButtonWrap=createDiv();productDislikeButtonWrap.classList=getProductReviewsInfoClassList(productReviewsWrap);const starsContainer=getStarsContainer(productReviewsWrap);const productDislikeButton=createDislikeButton((()=>dislikeProduct(starsContainer)));productDislikeButtonWrap.append(productDislikeButton);insertAfter(productReviewsWrap.parentNode,productDislikeButtonWrap)}function getProductReviewsInfoClassList(productReviewsWrap){return getFirstElement(".tsBodyControl500Medium",productReviewsWrap).classList}function getProductArticleFromPathname(){return getURLPathElementEnding(2,"unknown")}function dislikeProduct(starsContainer){const productArticle=getProductArticleFromPathname();setStoredRatingValue(productArticle,1);replaceRatingValue(starsContainer,1)}function appendBadReviewsLink(productReviewsWrap){const productReviewsLink=getFirstElement("a",productReviewsWrap);if(productReviewsLink){const productBadReviewsLinkWrap=createDiv();productBadReviewsLinkWrap.classList=getProductReviewsInfoClassList(productReviewsWrap);const productBadReviewsLink=createLink(`${productReviewsLink.href}?sort=score_asc`,thumbsDownIcon,"align-items: center; display: flex; color: rgba(0, 26, 52, 0.6);");const productBadReviewsLinkSpan=createSpan("Плохие отзывы","padding-left: 8px;");productBadReviewsLink.append(productBadReviewsLinkSpan);productBadReviewsLinkWrap.append(productBadReviewsLink);insertAfter(productReviewsWrap.parentNode,productBadReviewsLinkWrap)}}function appendRatingValue(starsContainer){const productArticle=getProductArticleFromPathname();const storedRatingValue=getStoredRatingValue(productArticle);storedRatingValue&&replaceRatingValue(starsContainer,storedRatingValue);waitForElement(document,'[data-widget="webReviewTabs"]').then((reviewsContainer=>{const reviewsContainerColumns=getAllElements('[data-widget="column"]',reviewsContainer);const reviewsInfoContainer=reviewsContainerColumns[2];waitForElement(reviewsInfoContainer,":scope > div:not([data-widget])").then((ratingInfoContainer=>{const ratingInfo=ratingInfoContainer.children[0];if(!ratingInfo)return;const ratingValue=getRatingValueFromRatingInfo(ratingInfo);if(!ratingValue)return;setStoredRatingValue(productArticle,ratingValue);replaceRatingValue(starsContainer,ratingValue)}))}))}function getRatingValueFromRatingInfo(ratingInfo){const ratingCounters=ratingInfo.children[2].children;if(!ratingCounters)return null;let reviewCounterSum=0;let ratingWeightSum=0;[...ratingCounters].forEach((ratingCounter=>{const ratingWrap=ratingCounter.children[0];const rating=getElementInnerNumber(ratingWrap,true);const reviewCounterWrap=ratingCounter.children[2];const reviewCounter=getElementInnerNumber(reviewCounterWrap);const ratingWeight=rating*reviewCounter;reviewCounterSum+=reviewCounter;ratingWeightSum+=ratingWeight}));if(!reviewCounterSum)return null;const ratingValue=ratingWeightSum/reviewCounterSum;const ratingValueRounded=Math.round((ratingValue+Number.EPSILON)*1e3)/1e3;return ratingValueRounded}function getStarsContainer(productReviewsWrap){return productReviewsWrap.children[0].children[1]}function replaceRatingValue(starsContainer,ratingValue){const starsContainerTextArray=starsContainer.textContent.split(" • ");const reviewsCountText=starsContainerTextArray[1]??starsContainerTextArray[0];starsContainer.textContent=[ratingValue,reviewsCountText].join(" • ")}function initAppendPriceHistory(){waitForElement(document,'[data-widget="webPrice"]').then((priceContainer=>{if(!priceContainer)return;const productArticle=getProductArticleFromPathname();appendPriceHistory(priceContainer,productArticle)}))}function skipFirstGalleryVideo(){waitForElement(document,'[data-widget="webGallery"]').then((webGallery=>{const firstGalleryItem=getFirstElement('[data-index="0"]',webGallery);if(!firstGalleryItem)return;const secondGalleryItem=getFirstElement('[data-index="1"]',webGallery);if(!secondGalleryItem)return;const firstGalleryItemIsImage=[...secondGalleryItem.classList].every((ic=>firstGalleryItem.classList.contains(ic)));if(firstGalleryItemIsImage)return;secondGalleryItem.click()}))}function extendProductNameMaxHeight(){waitForElement(document,'[data-widget="webProductHeading"]').then((webProductHeading=>{const productName=getFirstElement("h1",webProductHeading);productName.style.maxHeight="90px"}))}


const COMMENTS_SELECTOR="#comments";migrateDatabase();function migrateDatabase(){const actualDBVersion=3;const dbVersion=getStorageValue("dbVersion");if(dbVersion===actualDBVersion)return;const filterCondition=key=>key.endsWith("-lp");const priceKeys=window.GM_listValues().filter(filterCondition);priceKeys.forEach((key=>{const object=getStorageValue(key);const{value}=object;if(value===0){console.log(key);console.log(value);window.GM_deleteValue(key)}}));setStorageValue("dbVersion",actualDBVersion)}hideUnwantedElements();function hideUnwantedElements(){const css='[data-widget="bigPromoPDP"],'+'[data-widget="blackFridayStatus"],'+'[data-widget="cellList"],'+'[data-widget="skuGrid"],'+'[data-widget="skuShelfGoods"],'+'[data-widget="tagList"],'+'[data-widget="webInstallmentPurchase"],'+'[data-widget="webOneClickButton"] {'+"   display: none !important;"+"}";addGlobalStyle(css)}const{body}=document;if(isBodyInitialized())initMods();else{const observer=new MutationObserver((()=>{if(isBodyInitialized()){observer.disconnect();initMods()}}));observer.observe(body,{attributes:true,attributeFilter:["class"]})}function isBodyInitialized(){return body.classList.contains("vsc-initialized")}function initMods(){if(somePathElementEquals("gocheckout"))isAutoCheckout()&&autoBuyIfGoodPrice();else if(somePathElementEquals("cart"))isAutoSkipCart()?autoSkipCartOrReload():isAutoCheckout()&&checkCheckoutGoodPrice();else{replaceFavoritesLink();if(paginatorContent)initProductListMods();else if(somePathElementEquals("reviews")){const comments=getFirstElement(COMMENTS_SELECTOR);comments&&comments.scrollIntoView()}else somePathElementEquals("product")?initProductPageMods():somePathElementEquals("favorites")&&initFavoritesMods()}}function isAutoCheckout(){return isBoolStorageOption("autoCheckout")}function isAutoSkipCart(){return isBoolStorageOption("autoSkipCart")}function isAutoReloadCheckout(){return isBoolStorageOption("autoReloadCheckout")}function isAutoCheckoutProd(){return isBoolStorageOption("autoCheckoutProd")}function isBoolStorageOption(key){const boolStorageOption=getBoolStorageOption(key);return boolStorageOption==="1"}function getBoolStorageOption(key){let boolStorageOption=localStorage.getItem(key);if(boolStorageOption===null){boolStorageOption="0";localStorage.setItem(key,boolStorageOption)}return boolStorageOption}function autoSkipCartOrReload(){const totalWidgetDesktop=getTotalWidgetDesktop();const checkoutButton=getCheckoutButton(totalWidgetDesktop);checkoutButton.hasAttribute("disabled")?setTimeout((()=>window.location.reload()),1500):checkoutButton.click()}function checkCheckoutGoodPrice(){const storedCheckoutGoodPrice=localStorage.getItem("autoCheckoutGoodPrice");if(storedCheckoutGoodPrice!==null){console.log("autoCheckoutGoodPrice: ",storedCheckoutGoodPrice);return}if(confirm("Установить цену для автопокупки?")){const autoCheckoutGoodPrice=prompt("Введите допустимую цену:");localStorage.setItem("autoCheckoutGoodPrice",autoCheckoutGoodPrice)}}function autoBuyIfGoodPrice(){const totalWidgetDesktop=getTotalWidgetDesktop();const checkoutButton=getCheckoutButton(totalWidgetDesktop);if(checkoutButton.hasAttribute("disabled")&&isAutoReloadCheckout()){setTimeout((()=>window.location.reload()),1500);return}const priceContainer=totalWidgetDesktop.children[1].lastElementChild.children[1];const price=getElementInnerNumber(priceContainer,true);const autoCheckoutGoodPrice=localStorage.getItem("autoCheckoutGoodPrice");if(autoCheckoutGoodPrice===null){console.log("No autoCheckoutGoodPrice in localStorage");return}const autoCheckoutGoodPriceNumber=+autoCheckoutGoodPrice;if(price<=autoCheckoutGoodPriceNumber){if(isAutoCheckoutProd()){checkoutButton.click();console.log("Реальная покупка")}else console.log("Тестовая покупка");console.log("autoCheckoutGoodPrice: ",autoCheckoutGoodPriceNumber);console.log("price: ",price)}else{console.log("autoCheckoutGoodPrice: ",autoCheckoutGoodPriceNumber);console.log("price: ",price);console.log("Дорого!");isAutoReloadCheckout()&&setTimeout((()=>window.location.reload()),1500)}}function getTotalWidgetDesktop(){const totalWidget=getFirstElement('[data-widget="total"]');return totalWidget.children[0]}function getCheckoutButton(totalWidgetDesktop){return getFirstElement("button",totalWidgetDesktop)}function replaceFavoritesLink(){waitForElement(document,'[data-widget="favoriteCounter"]').then((favoritesLink=>{favoritesLink.href+="?avail=inStock"}))}})();